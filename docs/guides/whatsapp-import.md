# Руководство по импорту данных из WhatsApp

> **Версия**: 1.0  
> **Дата создания**: 2025-12-21  
> **Статус**: Готово к использованию

## Обзор

Это руководство описывает процесс импорта существующих данных из WhatsApp в CRM систему. Импорт выполняется через CLI скрипт и позволяет загрузить исторические переписки с клиентами.

## Предварительные требования

1. **База данных настроена**
   - PostgreSQL запущен и доступен
   - Миграции применены (`npm run db:migrate`)
   - Seed данные созданы (`npm run db:seed`)

2. **Организация создана**
   - В базе данных должна существовать организация
   - Для Soul KG: ID = `8ffef617-5216-403e-9633-224a13d70670`

3. **WhatsApp аккаунт**
   - Активный WhatsApp Business аккаунт
   - Доступ к телефону для сканирования QR кода

4. **Опционально: OpenRouter API ключ**
   - Только если используется LLM для детекции статусов
   - Можно указать через `--openrouter-key` или переменную окружения `OPENROUTER_API_KEY`
   - Получить можно на [OpenRouter.ai](https://openrouter.ai/)
   - **Рекомендуется**: Сохранить в `.env` файл (не коммитить в Git!)

## Быстрый старт

### 1. Тестовый импорт (5 чатов)

```bash
npm run import:whatsapp -- \
  --organization-id 8ffef617-5216-403e-9633-224a13d70670 \
  --limit 5 \
  --dry-run
```

Этот команда:
- Импортирует только 5 чатов (для тестирования)
- Не сохраняет данные в БД (`--dry-run`)
- Использует эвристическую детекцию статусов

### 2. Полный импорт с LLM детекцией

**Вариант A: Используя переменную окружения (рекомендуется)**

```bash
# Убедитесь что OPENROUTER_API_KEY в .env файле
npm run import:whatsapp -- \
  --organization-id 8ffef617-5216-403e-9633-224a13d70670 \
  --use-llm
```

**Вариант B: Через параметр командной строки**

```bash
npm run import:whatsapp -- \
  --organization-id 8ffef617-5216-403e-9633-224a13d70670 \
  --use-llm \
  --openrouter-key YOUR_API_KEY
```

## Параметры командной строки

### Обязательные параметры

- `--organization-id <uuid>` - ID организации в базе данных

### Опциональные параметры

- `--dry-run` - Тестовый запуск без сохранения в БД
- `--limit <number>` - Ограничить количество чатов для импорта (для тестирования)
- `--use-llm` - Использовать LLM для детекции статусов клиентов
- `--openrouter-key <key>` - API ключ OpenRouter (обязателен если используется `--use-llm`)
- `--skip-duplicates` - Пропускать дубликаты клиентов (по умолчанию: true)
- `--no-skip-duplicates` - Не пропускать дубликаты
- `--help` или `-h` - Показать справку

## Процесс импорта

### Шаг 1: Запуск скрипта

```bash
npm run import:whatsapp -- --organization-id YOUR_ORG_ID
```

### Шаг 2: Авторизация WhatsApp

1. Скрипт выведет QR код в консоль
2. Откройте WhatsApp на телефоне
3. Перейдите в **Settings → Linked Devices → Link a Device**
4. Отсканируйте QR код из консоли
5. Дождитесь подтверждения авторизации

### Шаг 3: Импорт данных

После авторизации скрипт автоматически:
1. Извлечет все контакты из WhatsApp
2. Для каждого контакта извлечет историю сообщений
3. Определит язык общения
4. Определит статус клиента (эвристика или LLM)
5. Валидирует данные
6. Проверит на дубликаты
7. Импортирует в базу данных

### Шаг 4: Результаты

Скрипт выведет отчет об импорте:
- Общее количество чатов
- Успешно импортировано
- Пропущено (дубликаты)
- Ошибки (если есть)

## Примеры использования

### Пример 1: Тестовый импорт (5 чатов, без сохранения)

```bash
npm run import:whatsapp -- \
  --organization-id 8ffef617-5216-403e-9633-224a13d70670 \
  --limit 5 \
  --dry-run
```

**Когда использовать**: Для проверки что все работает перед полным импортом.

### Пример 2: Импорт с LLM детекцией статусов

```bash
# Если OPENROUTER_API_KEY в .env файле
npm run import:whatsapp -- \
  --organization-id 8ffef617-5216-403e-9633-224a13d70670 \
  --use-llm

# Или через параметр командной строки
npm run import:whatsapp -- \
  --organization-id 8ffef617-5216-403e-9633-224a13d70670 \
  --use-llm \
  --openrouter-key sk-or-v1-xxxxx
```

**Когда использовать**: Когда нужна более точная детекция статусов клиентов. LLM анализирует контекст диалога и определяет статус более точно чем эвристика.

### Пример 3: Импорт без пропуска дубликатов

```bash
npm run import:whatsapp -- \
  --organization-id 8ffef617-5216-403e-9633-224a13d70670 \
  --no-skip-duplicates
```

**Когда использовать**: Когда нужно обновить существующие данные.

## Что импортируется

### Клиенты
- Телефон (обязательно)
- Имя (если есть в WhatsApp)
- Предпочитаемый язык (определяется автоматически)
- Статус в воронке продаж (определяется автоматически)

### Сообщения
- Текст сообщений
- Дата и время
- Направление (входящее/исходящее)
- Тип (текст, изображение, видео, документ)

### Разговоры
- История общения с клиентом
- Первое сообщение
- Последнее сообщение
- Канал связи (WhatsApp)

## Обработка ошибок

### Ошибка авторизации

Если QR код не работает:
1. Убедитесь что WhatsApp на телефоне активен
2. Проверьте интернет соединение
3. Очистите сессии WhatsApp:
   ```bash
   npm run import:clear-sessions
   ```
   Или вручную:
   ```bash
   rm -rf .whatsapp-sessions/
   ```
4. Подождите 10-30 минут перед следующей попыткой
5. Перезапустите скрипт

### Ошибка "Связать устройство сейчас невозможно"

**Причина**: WhatsApp ограничивает частоту попыток подключения. Если вы пытались подключиться слишком много раз подряд, WhatsApp временно блокирует новые подключения.

**Решение**:
1. **Подождите 10-30 минут** перед следующей попыткой
2. Удалите сессии WhatsApp:
   ```bash
   rm -rf .whatsapp-sessions/
   ```
3. Убедитесь что на телефоне нет других активных сессий WhatsApp Web (отключите их в настройках)
4. Попробуйте снова через некоторое время

**Профилактика**:
- Не запускайте скрипт импорта слишком часто
- Если импорт прервался, подождите перед повторной попыткой
- Используйте сохраненную сессию (после первого успешного подключения)

### Ошибки импорта

Если некоторые чаты не импортировались:
1. Проверьте логи ошибок в выводе скрипта
2. Убедитесь что данные валидны (телефон в правильном формате)
3. Проверьте подключение к базе данных

### Дубликаты

Если клиент уже существует:
- По умолчанию дубликаты пропускаются
- Используйте `--no-skip-duplicates` для обновления существующих данных

## Проверка результатов

После импорта проверьте данные:

```bash
# Откройте Prisma Studio
npm run db:studio

# Или используйте SQL запросы
psql soul_kg_crm -c "SELECT COUNT(*) FROM clients WHERE organization_id = 'YOUR_ORG_ID';"
```

## Ограничения

1. **Количество чатов**: Рекомендуется импортировать не более 100 чатов за раз
2. **Время импорта**: Импорт может занять от нескольких минут до часа в зависимости от объема данных
3. **WhatsApp Web**: Требуется активное подключение к интернету и WhatsApp Web

## Следующие шаги

После успешного импорта:
1. Проверьте качество импортированных данных
2. Проверьте корректность статусов клиентов
3. При необходимости обновите seed данные на основе реальных данных
4. Начните использовать CRM систему с реальными данными

## Поддержка

При возникновении проблем:
1. Проверьте логи скрипта
2. Проверьте документацию модуля: `docs/modules/data-import.md`
3. Проверьте статус базы данных: `DATABASE_STATUS.md`

