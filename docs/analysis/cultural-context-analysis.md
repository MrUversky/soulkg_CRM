# Анализ проблемы определения культурного контекста

## Проблема

### Текущий подход (только язык)
**Проблемы:**
- В ОАЭ живут люди из разных стран (Индия, Пакистан, Филиппины, Европа, Арабские страны)
- Язык общения (английский) ≠ культурный контекст
- Телефон (+971) показывает локацию, а не происхождение
- Недостаточно данных для точного определения

### Примеры проблемных случаев:
1. **Индиец в ОАЭ**: пишет на английском, телефон +971 → определяется как "English-speaking expat", но нужен Halal, формальность
2. **Европеец в ОАЭ**: пишет на английском, телефон +971 → определяется как "English-speaking expat", но не нужен Halal, более неформальный стиль
3. **Араб в ОАЭ**: пишет на арабском, телефон +971 → определяется правильно
4. **Русский в ОАЭ**: пишет на русском, телефон +971 → определяется как "Central Asia", но телефон показывает UAE

## Варианты решения

### Вариант 1: Комбинированный эвристический подход (быстро, дешево)

**Идея:** Использовать несколько источников информации с весами

**Источники:**
1. **Язык сообщений** (вес: 40%)
   - Арабский → Middle East, formal, Halal
   - Русский → CIS/Central Asia
   - Европейские языки → Europe
   - Английский → неопределенный (нужны другие источники)

2. **Код телефона** (вес: 30%)
   - Показывает текущую локацию (для timezone)
   - Может дать подсказку о происхождении (если не UAE)

3. **Анализ контента сообщений** (вес: 30%)
   - Упоминания стран: "I'm from India", "I live in Dubai but I'm Pakistani"
   - Культурные маркеры: "Inshallah", "Namaste", упоминания религиозных праздников
   - Стиль общения: формальность, использование титулов

**Плюсы:**
- Быстро (не требует LLM)
- Дешево
- Работает офлайн

**Минусы:**
- Менее точное
- Может пропустить нюансы

### Вариант 2: LLM-based определение (точнее, но дороже)

**Идея:** Использовать LLM для анализа всего контекста

**Входные данные:**
- Язык сообщений
- Код телефона
- Примеры сообщений (первые 3-5 сообщений клиента)
- Контекст диалога

**Промпт для LLM:**
```
Analyze the cultural context of this client based on:
- Language used: {language}
- Phone country code: {phone_code}
- Sample messages: {messages}

Determine:
1. Likely origin/cultural background (not just current location)
2. Communication style (formal/informal/mixed)
3. Dietary preferences (Halal, vegetarian, etc.)
4. Cultural notes for respectful communication

Consider that in UAE, people from many countries live there.
```

**Плюсы:**
- Более точное определение
- Учитывает контекст и нюансы
- Может определить происхождение даже при английском языке

**Минусы:**
- Дороже (каждый клиент = LLM запрос)
- Медленнее
- Зависит от качества промпта

### Вариант 3: Гибридный подход (рекомендуемый)

**Идея:** Комбинация эвристики + LLM для сложных случаев

**Логика:**
1. **Простые случаи** (эвристика):
   - Арабский язык → Middle East, formal, Halal
   - Русский язык → CIS/Central Asia
   - Европейские языки → Europe
   - Язык + телефон совпадают (например, французский + французский телефон)

2. **Сложные случаи** (LLM):
   - Английский язык + UAE телефон → LLM анализ
   - Смешанные языки
   - Неопределенные случаи

**Плюсы:**
- Баланс между точностью и стоимостью
- Быстро для простых случаев
- Точно для сложных

**Минусы:**
- Нужна логика определения "сложных случаев"
- Все равно требует LLM для части клиентов

### Вариант 4: Минималистичный подход (самый простой)

**Идея:** Не пытаться угадать происхождение, использовать только то, что точно знаем

**Логика:**
- **Язык** → стиль общения и язык ответов
- **Телефон** → timezone (где они сейчас)
- **Культурные заметки** → только если явно указано (например, арабский язык = Halal)

**Плюсы:**
- Простота
- Нет ложных предположений
- Легко поддерживать

**Минусы:**
- Меньше персонализации
- Может быть недостаточно для некоторых случаев

## Рекомендация

**Рекомендую Вариант 3 (Гибридный)** с упором на простоту:

1. **Для явных случаев** (80% клиентов) - эвристика:
   - Арабский → Middle East, formal, Halal
   - Русский → CIS
   - Европейские языки → Europe
   - Язык совпадает с телефоном → используем оба

2. **Для неопределенных** (20% клиентов) - LLM:
   - Английский + UAE телефон
   - Смешанные языки
   - Можно сделать опционально (флаг `useLLMCulturalContext`)

3. **Всегда используем телефон для:**
   - Timezone (где они сейчас)
   - Но не для культурного контекста (откуда они родом)

4. **Добавляем анализ контента** (простая эвристика):
   - Поиск упоминаний стран в сообщениях
   - Культурные маркеры ("Inshallah", "Namaste", etc.)

## Вопросы для уточнения

1. Насколько критично точное определение происхождения?
2. Готовы ли платить за LLM для каждого клиента?
3. Можно ли начать с простого и улучшать по мере накопления данных?
4. Есть ли возможность собирать данные о клиентах явно (опрос при первом контакте)?

