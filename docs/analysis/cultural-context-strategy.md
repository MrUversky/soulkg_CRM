# Стратегия определения и обновления культурного контекста

## Решение: LLM-based определение

**Идея:** Используем тот же LLM запрос для статуса, чтобы также определить культурный контекст.

**Преимущества:**
- Один запрос вместо двух (экономия)
- LLM видит полный контекст диалога
- Более точное определение происхождения и культурных особенностей
- Учитывает нюансы (например, индиец в ОАЭ vs европеец в ОАЭ)

## Когда обновлять культурный контекст

### При импорте (первичная загрузка)
- **Всегда** определяем культурный контекст
- Используем все доступные сообщения

### При новых сообщениях (runtime)

**Стратегия обновления:**

1. **Обновлять всегда, если:**
   - Клиент новый (нет culturalContext)
   - Изменился язык сообщений (был русский, стал английский)
   - Прошло >30 дней с последнего обновления
   - Меньше 5 сообщений было при первом определении (недостаточно данных)

2. **Обновлять опционально (можно настроить), если:**
   - Прошло >7 дней с последнего обновления
   - Появились новые культурные маркеры в сообщениях
   - Клиент явно упомянул страну/происхождение

3. **Не обновлять, если:**
   - Культурный контекст уже определен с высокой уверенностью
   - Прошло <7 дней с последнего обновления
   - Язык не изменился и нет новых данных

## Формат ответа LLM

Расширяем JSON ответ для включения культурного контекста:

```json
{
  "status": "QUALIFIED",
  "confidence": 0.85,
  "reasoning": "...",
  "culturalContext": {
    "likelyOrigin": "India",
    "region": "South Asia",
    "communicationStyle": "formal",
    "dietaryRestrictions": ["Halal", "Vegetarian"],
    "culturalNotes": [
      "May prefer formal greetings",
      "Consider time zone differences (UAE GMT+4)"
    ],
    "confidence": 0.8
  }
}
```

## Реализация

### 1. Обновить промпт статуса
Добавить секцию про культурный контекст в промпт

### 2. Расширить интерфейс результата
Добавить `culturalContext` в `StatusDetectionResult`

### 3. Стратегия обновления
Создать функцию `shouldUpdateCulturalContext()` для определения необходимости обновления

### 4. Интеграция в обработку сообщений
При обработке новых сообщений проверять необходимость обновления




