# Development Workflow

## Принципы разработки

### 1. Итеративная разработка
- Маленькие итерации (1-3 дня)
- Каждая итерация заканчивается работающей функциональностью
- Регулярные проверки и валидация

### 2. Test-Driven Development (где применимо)
- Для критичных модулей пишем тесты сначала
- Для остальных - тесты параллельно с кодом
- Минимум 70% покрытие критичных модулей

### 3. Clean Code
- Код должен быть читаемым и понятным
- Используем TypeScript строгий режим
- Следуем принципам SOLID
- Регулярный рефакторинг

### 4. Документация
- Код документируется через комментарии и JSDoc
- API документируется через OpenAPI/Swagger
- Архитектурные решения документируются в docs/

## Workflow этапов

### Этап 0: Планирование (Agent Factory)

#### Шаг 1: Создание агента
1. Агент Factory создает шаблон нового агента
2. Определяет структуру, промпты, инструменты
3. Создает чек-лист валидации

#### Шаг 2: Продуктовый анализ
1. Продуктовый агент анализирует требования
2. Создает user stories и use cases
3. Определяет MVP scope

#### Шаг 3: Архитектурное проектирование
1. Агент архитектуры проектирует модуль
2. Определяет интерфейсы и контракты
3. Проектирует схему БД (если нужно)

#### Шаг 4: Планирование разработки
1. Разбиваем на задачи
2. Оцениваем время
3. Определяем зависимости

**Артефакты**:
- Шаблон агента
- User stories
- Архитектурный дизайн
- План разработки

### Этап 1: Разработка

#### Шаг 1: Настройка окружения
```bash
# Создание ветки
git checkout -b feature/agent-qualification

# Установка зависимостей
npm install

# Настройка переменных окружения
cp .env.example .env
```

#### Шаг 2: Разработка модуля
1. Создаем структуру модуля
2. Пишем интерфейсы и типы
3. Реализуем функциональность
4. Пишем тесты параллельно

#### Шаг 3: Интеграция
1. Подключаем модуль к системе
2. Настраиваем маршруты/эндпоинты
3. Интегрируем с другими модулями
4. Тестируем интеграцию

#### Шаг 4: Валидация
1. Проверяем соответствие требованиям
2. Запускаем все тесты
3. Проверяем линтер
4. Проверяем производительность

**Артефакты**:
- Код модуля
- Тесты
- Миграции БД (если нужно)
- Обновленная документация

### Этап 2: Тестирование

#### Unit тесты
```bash
npm run test:unit
```

#### Integration тесты
```bash
npm run test:integration
```

#### E2E тесты
```bash
npm run test:e2e
```

#### Ручное тестирование
- Проверка основных сценариев
- Проверка edge cases
- Проверка UI/UX

### Этап 3: Документация

#### Обновление документации
1. API документация (если изменились эндпоинты)
2. README модуля
3. Changelog
4. Архитектурная документация (если нужно)

#### Cleanup
1. Удаление временных файлов
2. Удаление закомментированного кода
3. Очистка тестовых данных
4. Оптимизация импортов

### Этап 4: Code Review

#### Перед созданием PR
- [ ] Все тесты проходят
- [ ] Линтер не выдает ошибок
- [ ] Документация обновлена
- [ ] Код соответствует стандартам
- [ ] Миграции БД протестированы

#### Создание PR
```bash
git add .
git commit -m "feat: add qualification agent"
git push origin feature/agent-qualification
# Создать PR через GitHub UI
```

#### Code Review чек-лист
- [ ] Код читаемый и понятный
- [ ] Нет дублирования кода
- [ ] Обработка ошибок реализована
- [ ] Тесты покрывают критичные случаи
- [ ] Производительность приемлема
- [ ] Безопасность учтена

### Этап 5: Деплой

#### Подготовка к деплою
1. Обновление версии (semantic versioning)
2. Обновление CHANGELOG.md
3. Создание release notes
4. Проверка переменных окружения

#### Деплой на staging
```bash
# Автоматический деплой через CI/CD
git tag v1.0.0
git push --tags
```

#### Тестирование на staging
- Smoke tests
- Проверка основных функций
- Проверка производительности

#### Деплой на production
- После успешного тестирования на staging
- Деплой в нерабочее время (если возможно)
- Мониторинг после деплоя
- Rollback план готов

## Структура коммитов

Используем [Conventional Commits](https://www.conventionalcommits.org/):

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Типы коммитов
- `feat`: новая функциональность
- `fix`: исправление бага
- `docs`: изменения в документации
- `style`: форматирование кода
- `refactor`: рефакторинг
- `test`: добавление/изменение тестов
- `chore`: изменения в build процессе, зависимостях

### Примеры
```
feat(agents): add qualification agent

Implements basic qualification logic with budget and date detection.
Updates client status automatically based on qualification score.

Closes #123
```

```
fix(whatsapp): handle connection errors gracefully

Adds retry logic and proper error messages for WhatsApp connection issues.

Fixes #456
```

## Работа с агентами

### Создание нового агента

1. **Используем Agent Factory Agent**
   ```bash
   # Запускаем агента для создания шаблона
   npm run agent:create -- --name qualification-agent
   ```

2. **Следуем шаблону**
   - Структура из `docs/agent-templates/`
   - Системный промпт из шаблона
   - Инструменты из стандартного набора

3. **Тестируем агента**
   ```bash
   npm run test:agent -- qualification-agent
   ```

4. **Интегрируем в систему**
   - Регистрируем в системе агентов
   - Настраиваем маршрутизацию сообщений
   - Добавляем в мониторинг

### Взаимодействие агентов

```typescript
// Пример: Агент A вызывает Агент B
import { agentMessaging } from '@/packages/agents/messaging';

const result = await agentMessaging.send({
  from: 'agent-a',
  to: 'agent-b',
  action: 'perform_action',
  payload: { data: '...' },
  context: { clientId: '...', organizationId: '...' }
});
```

## Мониторинг и логирование

### Структура логов
```typescript
logger.info('Agent action', {
  agentId: 'qualification-agent',
  action: 'qualify_lead',
  clientId: 'client-123',
  traceId: 'trace-abc',
  duration: 1234,
  result: { status: 'qualified', score: 0.85 }
});
```

### Метрики
- Время выполнения агентов
- Количество успешных/неуспешных операций
- Использование токенов LLM
- Количество сообщений обработано

## Troubleshooting

### Проблемы с агентами
1. Проверить логи агента
2. Проверить конфигурацию
3. Проверить доступность LLM API
4. Проверить контекст и память

### Проблемы с интеграциями
1. Проверить подключение (WhatsApp, Telegram)
2. Проверить webhooks
3. Проверить rate limits
4. Проверить логи интеграций

### Проблемы с БД
1. Проверить миграции
2. Проверить индексы
3. Проверить connection pool
4. Проверить производительность запросов

