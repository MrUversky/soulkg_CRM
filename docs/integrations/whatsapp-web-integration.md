# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WhatsApp Web

## üéØ –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **WhatsApp Web** —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `whatsapp-web.js` –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º—ã —ç–º—É–ª–∏—Ä—É–µ–º –≤–µ–±-–∫–ª–∏–µ–Ω—Ç WhatsApp –∏ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä–Ω—É—é —Å–µ—Å—Å–∏—é.

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
1. **–û–¥–Ω–∞ —Å–µ—Å—Å–∏—è –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç**: –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è WhatsApp Web
2. **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å QR-–∫–æ–¥–∞**: –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞
3. **–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏**: –°–µ—Å—Å–∏—è –º–æ–∂–µ—Ç —Ä–∞–∑–æ—Ä–≤–∞—Ç—å—Å—è, —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
4. **Rate Limits**: WhatsApp –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
5. **–ù–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ API**: –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏, –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ WhatsApp

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- ‚ùå –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ (—Ä–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
- ‚ùå –ù–µ—Ç webhook –æ—Ç WhatsApp (–Ω—É–∂–Ω–æ —Å–∞–º–∏–º —Å–ª—É—à–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è)
- ‚ùå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚ö†Ô∏è –†–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø—Ä–∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  WhatsApp Web   ‚îÇ
‚îÇ     Client      ‚îÇ ‚Üê whatsapp-web.js
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Message Queue  ‚îÇ ‚Üê BullMQ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Message Handler‚îÇ ‚Üê –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö/–∏—Å—Ö–æ–¥—è—â–∏—Ö
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AI Agents      ‚îÇ ‚Üê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Database       ‚îÇ ‚Üê –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

```
packages/
‚îî‚îÄ‚îÄ whatsapp/
    ‚îú‚îÄ‚îÄ client/              # WhatsApp –∫–ª–∏–µ–Ω—Ç
    ‚îÇ   ‚îú‚îÄ‚îÄ whatsapp-client.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ session-manager.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ connection-handler.ts
    ‚îú‚îÄ‚îÄ handlers/            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    ‚îÇ   ‚îú‚îÄ‚îÄ message-handler.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ status-handler.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ error-handler.ts
    ‚îú‚îÄ‚îÄ queue/               # –û—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    ‚îÇ   ‚îú‚îÄ‚îÄ message-queue.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ send-message-job.ts
    ‚îî‚îÄ‚îÄ types/               # –¢–∏–ø—ã
        ‚îî‚îÄ‚îÄ whatsapp.types.ts
```

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. WhatsApp Client Service

```typescript
// packages/whatsapp/client/whatsapp-client.ts

import { Client, LocalAuth, Message } from 'whatsapp-web.js';
import { EventEmitter } from 'events';

export class WhatsAppClient extends EventEmitter {
  private client: Client;
  private organizationId: string;
  private isConnected: boolean = false;
  private reconnectAttempts: number = 0;
  private maxReconnectAttempts: number = 5;

  constructor(organizationId: string) {
    super();
    this.organizationId = organizationId;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–µ—Å—Å–∏–∏
    this.client = new Client({
      authStrategy: new LocalAuth({
        clientId: `org-${organizationId}`,
        dataPath: `.whatsapp-sessions/org-${organizationId}`
      }),
      puppeteer: {
        headless: true,
        args: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-dev-shm-usage',
          '--disable-accelerated-2d-canvas',
          '--no-first-run',
          '--no-zygote',
          '--disable-gpu'
        ]
      }
    });

    this.setupEventHandlers();
  }

  private setupEventHandlers() {
    // QR –∫–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    this.client.on('qr', (qr) => {
      this.emit('qr', qr);
      console.log(`[WhatsApp ${this.organizationId}] QR Code generated`);
    });

    // –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–±–æ—Ç–µ
    this.client.on('ready', () => {
      this.isConnected = true;
      this.reconnectAttempts = 0;
      this.emit('ready');
      console.log(`[WhatsApp ${this.organizationId}] Client is ready!`);
    });

    // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
    this.client.on('authenticated', () => {
      console.log(`[WhatsApp ${this.organizationId}] Authenticated`);
    });

    // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ—É—Å–ø–µ—à–Ω–∞
    this.client.on('auth_failure', (msg) => {
      console.error(`[WhatsApp ${this.organizationId}] Auth failure:`, msg);
      this.emit('auth_failure', msg);
    });

    // –†–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    this.client.on('disconnected', (reason) => {
      this.isConnected = false;
      console.warn(`[WhatsApp ${this.organizationId}] Disconnected:`, reason);
      this.emit('disconnected', reason);
      this.handleReconnect();
    });

    // –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    this.client.on('message', async (message: Message) => {
      await this.handleIncomingMessage(message);
    });

    // –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è
    this.client.on('message_ack', (msg, ack) => {
      this.emit('message_ack', { msg, ack });
    });
  }

  async initialize(): Promise<void> {
    try {
      await this.client.initialize();
    } catch (error) {
      console.error(`[WhatsApp ${this.organizationId}] Initialization error:`, error);
      throw error;
    }
  }

  async sendMessage(to: string, content: string): Promise<Message> {
    if (!this.isConnected) {
      throw new Error('WhatsApp client is not connected');
    }

    try {
      const number = this.formatPhoneNumber(to);
      const message = await this.client.sendMessage(number, content);
      return message;
    } catch (error) {
      console.error(`[WhatsApp ${this.organizationId}] Send message error:`, error);
      throw error;
    }
  }

  async handleIncomingMessage(message: Message) {
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–µ–±—è
    if (message.fromMe) return;

    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å—ã –∏ –≥—Ä—É–ø–ø–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    if (message.isStatus || message.from.includes('@g.us')) {
      return;
    }

    this.emit('message', {
      id: message.id._serialized,
      from: message.from,
      to: message.to,
      body: message.body,
      timestamp: message.timestamp,
      hasMedia: message.hasMedia,
      type: message.type
    });
  }

  private formatPhoneNumber(phone: string): string {
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è WhatsApp (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)
    // –ü—Ä–∏–º–µ—Ä: +996555123456 -> 996555123456@c.us
    const cleaned = phone.replace(/\D/g, '');
    return `${cleaned}@c.us`;
  }

  private async handleReconnect() {
    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
      console.error(`[WhatsApp ${this.organizationId}] Max reconnect attempts reached`);
      this.emit('max_reconnect_reached');
      return;
    }

    this.reconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000); // Exponential backoff
    
    console.log(`[WhatsApp ${this.organizationId}] Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts})`);
    
    setTimeout(async () => {
      try {
        await this.client.initialize();
      } catch (error) {
        console.error(`[WhatsApp ${this.organizationId}] Reconnect error:`, error);
        this.handleReconnect();
      }
    }, delay);
  }

  async destroy(): Promise<void> {
    await this.client.destroy();
    this.isConnected = false;
  }

  getConnectionStatus(): boolean {
    return this.isConnected;
  }

  async getQRCode(): Promise<string | null> {
    // QR –∫–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    // –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI
    return null; // –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ 'qr'
  }
}
```

### 2. Session Manager

```typescript
// packages/whatsapp/client/session-manager.ts

import { WhatsAppClient } from './whatsapp-client';
import { prisma } from '@/packages/database';

export class WhatsAppSessionManager {
  private clients: Map<string, WhatsAppClient> = new Map();

  async getOrCreateClient(organizationId: string): Promise<WhatsAppClient> {
    if (this.clients.has(organizationId)) {
      const client = this.clients.get(organizationId)!;
      if (client.getConnectionStatus()) {
        return client;
      }
      // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω
      await client.initialize();
      return client;
    }

    const client = new WhatsAppClient(organizationId);
    this.setupClientEvents(client, organizationId);
    
    await client.initialize();
    this.clients.set(organizationId, client);
    
    return client;
  }

  private setupClientEvents(client: WhatsAppClient, organizationId: string) {
    client.on('qr', async (qr) => {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º QR –∫–æ–¥ –≤ –ë–î –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI
      await prisma.whatsAppSession.upsert({
        where: { organizationId },
        update: { qrCode: qr, status: 'WAITING_QR' },
        create: { organizationId, qrCode: qr, status: 'WAITING_QR' }
      });
    });

    client.on('ready', async () => {
      await prisma.whatsAppSession.update({
        where: { organizationId },
        data: { status: 'CONNECTED', qrCode: null }
      });
    });

    client.on('disconnected', async (reason) => {
      await prisma.whatsAppSession.update({
        where: { organizationId },
        data: { status: 'DISCONNECTED', lastError: reason }
      });
    });
  }

  async disconnect(organizationId: string): Promise<void> {
    const client = this.clients.get(organizationId);
    if (client) {
      await client.destroy();
      this.clients.delete(organizationId);
    }
  }
}
```

### 3. Message Queue Handler

```typescript
// packages/whatsapp/queue/message-queue.ts

import Queue from 'bull';
import { WhatsAppSessionManager } from '../client/session-manager';
import { prisma } from '@/packages/database';

export class WhatsAppMessageQueue {
  private sendQueue: Queue;
  private sessionManager: WhatsAppSessionManager;

  constructor() {
    this.sendQueue = new Queue('whatsapp-send', {
      redis: {
        host: process.env.REDIS_HOST || 'localhost',
        port: parseInt(process.env.REDIS_PORT || '6379')
      },
      defaultJobOptions: {
        attempts: 3,
        backoff: {
          type: 'exponential',
          delay: 2000
        },
        removeOnComplete: true,
        removeOnFail: false
      }
    });

    this.sessionManager = new WhatsAppSessionManager();
    this.setupProcessors();
  }

  private setupProcessors() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    this.sendQueue.process('send-message', async (job) => {
      const { organizationId, to, content, conversationId } = job.data;
      
      try {
        const client = await this.sessionManager.getOrCreateClient(organizationId);
        const message = await client.sendMessage(to, content);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
        await prisma.message.create({
          data: {
            conversationId,
            content,
            direction: 'OUTGOING',
            whatsappMessageId: message.id._serialized,
            status: 'SENT',
            sentAt: new Date()
          }
        });

        return { success: true, messageId: message.id._serialized };
      } catch (error) {
        console.error('Send message error:', error);
        throw error;
      }
    });
  }

  async addSendMessageJob(data: {
    organizationId: string;
    to: string;
    content: string;
    conversationId: string;
  }): Promise<void> {
    await this.sendQueue.add('send-message', data, {
      priority: 1
    });
  }
}
```

### 4. Message Handler (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–≥–µ–Ω—Ç–∞–º–∏)

```typescript
// packages/whatsapp/handlers/message-handler.ts

import { WhatsAppClient } from '../client/whatsapp-client';
import { prisma } from '@/packages/database';
import { AgentOrchestrator } from '@/packages/agents/orchestrator';

export class WhatsAppMessageHandler {
  private agentOrchestrator: AgentOrchestrator;

  constructor() {
    this.agentOrchestrator = new AgentOrchestrator();
  }

  async handleIncomingMessage(data: {
    organizationId: string;
    from: string;
    body: string;
    messageId: string;
    timestamp: number;
  }) {
    const { organizationId, from, body, messageId, timestamp } = data;

    try {
      // –ù–∞—Ö–æ–¥–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
      let client = await prisma.client.findFirst({
        where: {
          organizationId,
          phone: this.extractPhoneNumber(from)
        }
      });

      if (!client) {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
        client = await prisma.client.create({
          data: {
            organizationId,
            phone: this.extractPhoneNumber(from),
            status: 'NEW_LEAD',
            source: 'WHATSAPP'
          }
        });
      }

      // –ù–∞—Ö–æ–¥–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä
      let conversation = await prisma.conversation.findFirst({
        where: {
          clientId: client.id,
          channel: 'WHATSAPP',
          status: 'ACTIVE'
        }
      });

      if (!conversation) {
        conversation = await prisma.conversation.create({
          data: {
            clientId: client.id,
            organizationId,
            channel: 'WHATSAPP',
            status: 'ACTIVE'
          }
        });
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const message = await prisma.message.create({
        data: {
          conversationId: conversation.id,
          content: body,
          direction: 'INCOMING',
          whatsappMessageId: messageId,
          status: 'RECEIVED',
          receivedAt: new Date(timestamp * 1000)
        }
      });

      // –ü–µ—Ä–µ–¥–∞–µ–º –∞–≥–µ–Ω—Ç—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
      const response = await this.agentOrchestrator.processMessage({
        organizationId,
        clientId: client.id,
        conversationId: conversation.id,
        message: body,
        context: {
          clientStatus: client.status,
          conversationHistory: await this.getRecentMessages(conversation.id)
        }
      });

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å
      if (response.reply) {
        await this.sendReply(organizationId, from, response.reply, conversation.id);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
      if (response.clientStatusUpdate) {
        await prisma.client.update({
          where: { id: client.id },
          data: { status: response.clientStatusUpdate }
        });
      }

    } catch (error) {
      console.error('Handle incoming message error:', error);
      // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –ø–∞–¥–∞–µ–º
    }
  }

  private extractPhoneNumber(whatsappId: string): string {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ WhatsApp (996555123456@c.us -> 996555123456)
    return whatsappId.split('@')[0];
  }

  private async getRecentMessages(conversationId: string, limit: number = 10) {
    return prisma.message.findMany({
      where: { conversationId },
      orderBy: { receivedAt: 'desc' },
      take: limit
    });
  }

  private async sendReply(
    organizationId: string,
    to: string,
    content: string,
    conversationId: string
  ) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const { WhatsAppMessageQueue } = await import('../queue/message-queue');
    const queue = new WhatsAppMessageQueue();
    await queue.addSendMessageJob({
      organizationId,
      to,
      content,
      conversationId
    });
  }
}
```

## üìä –°—Ö–µ–º–∞ –ë–î –¥–ª—è WhatsApp

```prisma
model WhatsAppSession {
  id            String   @id @default(cuid())
  organizationId String  @unique
  organization  Organization @relation(fields: [organizationId], references: [id])
  
  status        String   // CONNECTED, DISCONNECTED, WAITING_QR, ERROR
  qrCode        String?  // QR –∫–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  lastError     String?
  connectedAt   DateTime?
  disconnectedAt DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Message {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  
  content         String
  direction       String   // INCOMING, OUTGOING
  whatsappMessageId String? @unique
  
  status          String   // SENT, DELIVERED, READ, FAILED, RECEIVED
  receivedAt      DateTime?
  sentAt          DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([conversationId])
  @@index([whatsappMessageId])
}
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π
- –°–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ `.whatsapp-sessions/`
- –ö–∞–∂–¥–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏–º–µ–µ—Ç —Å–≤–æ—é –ø–∞–ø–∫—É —Å–µ—Å—Å–∏–∏
- –ü–∞–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ `.gitignore`
- –í production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (S3, encrypted volume)

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
```typescript
// Rate limiting –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
const RATE_LIMITS = {
  messagesPerMinute: 20,  // –ú–∞–∫—Å–∏–º—É–º 20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É
  messagesPerHour: 200,   // –ú–∞–∫—Å–∏–º—É–º 200 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Å
  messagesPerDay: 1000    // –ú–∞–∫—Å–∏–º—É–º 1000 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å
};
```

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è

1. **Disconnected**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å exponential backoff
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö

2. **QR Code —Ç—Ä–µ–±—É–µ—Ç—Å—è**
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ QR –≤ –ë–î
   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

3. **Rate Limit**
   - –û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
   - –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –≤–∞–∂–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤

4. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞**
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ—Ç WhatsApp
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–∏
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (connected/disconnected)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö/–ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- Rate limit –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```typescript
logger.info('WhatsApp message sent', {
  organizationId,
  to,
  messageId,
  duration: Date.now() - startTime
});

logger.error('WhatsApp connection error', {
  organizationId,
  error: error.message,
  stack: error.stack
});
```

## üéØ Best Practices

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—á–µ—Ä–µ–¥—å** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
2. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ gracefully** - –Ω–µ –ø–∞–¥–∞–π—Ç–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö WhatsApp
3. **–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è** –≤ –ë–î –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
5. **–°–æ–±–ª—é–¥–∞–π—Ç–µ rate limits** - –Ω–µ —Å–ø–∞–º—å—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞–º
6. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ** –ø–µ—Ä–µ–¥ production

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API (–±—É–¥—É—â–µ–µ)

–ö–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É API:
1. –°–æ–∑–¥–∞—Ç—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é `ChannelProvider` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `WhatsAppWebProvider` –∏ `WhatsAppApiProvider`
3. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
4. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤

