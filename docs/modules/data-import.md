# Модуль импорта данных из WhatsApp

> **Версия**: 1.0  
> **Дата создания**: 2025-12-20  
> **Последнее обновление**: 2025-12-20  
> **Статус**: MVP - Первая задача Development Agent

## Назначение

Модуль для импорта существующих данных из WhatsApp переписки в CRM систему. Это критичный модуль для MVP, так как позволяет загрузить исторические данные клиентов и начать работу с реальными данными.

## Приоритет

**Первая задача Development Agent** - должен быть реализован **в начале разработки MVP**, чтобы:
- Загрузить существующие данные клиентов
- Создать seed данные на основе реальных данных
- Начать разработку с реальными данными

## Архитектурное расширение

**Для MVP**: Только импорт из WhatsApp  
**Архитектурно заложено**: Расширение на другие источники данных:
- Telegram (post-MVP)
- Email (post-MVP)
- CSV/Excel импорт (post-MVP)
- API интеграции (post-MVP)

Модуль спроектирован с учетом возможности добавления новых источников данных через абстракцию `DataExtractor`.

## Объем данных

- **До 100 переписок** в WhatsApp
- Каждая переписка содержит:
  - Контакт клиента (имя, телефон)
  - История сообщений (входящие и исходящие)
  - Медиа файлы (фото, видео, документы)
  - Даты сообщений
  - Контекст общения (для определения статуса клиента)

## Архитектура модуля

### Компоненты

```
┌─────────────────────────────────────────┐
│      WhatsApp Web Client                │
│      (whatsapp-web.js)                  │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│      Data Extractor                     │
│      - Извлечение контактов             │
│      - Извлечение сообщений              │
│      - Парсинг неструктурированных данных│
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│      Data Parser                        │
│      - Определение языка                 │
│      - Извлечение структурированных данных│
│      - Определение статуса клиента      │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│      Data Validator                      │
│      - Валидация данных                  │
│      - Проверка дубликатов               │
│      - Обнаружение конфликтов            │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│      Data Importer                       │
│      - Создание клиентов                 │
│      - Создание сообщений                │
│      - Создание разговоров               │
│      - Обновление статусов               │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│      Database                            │
│      (PostgreSQL)                        │
└─────────────────────────────────────────┘
```

### Структура модуля

```
packages/
└── data-import/
    ├── extractors/
    │   ├── whatsapp-extractor.ts    # Извлечение данных из WhatsApp
    │   └── contact-extractor.ts     # Извлечение контактов
    ├── parsers/
    │   ├── message-parser.ts        # Парсинг сообщений
    │   ├── language-detector.ts     # Определение языка
    │   └── status-detector.ts       # Определение статуса клиента
    ├── validators/
    │   ├── data-validator.ts        # Валидация данных
    │   └── duplicate-detector.ts   # Обнаружение дубликатов
    ├── importers/
    │   ├── client-importer.ts       # Импорт клиентов
    │   ├── message-importer.ts      # Импорт сообщений
    │   └── conversation-importer.ts # Импорт разговоров
    ├── ui/
    │   └── import-wizard.tsx        # UI для импорта (опционально)
    └── types/
        └── import.types.ts           # Типы для импорта
```

## Процесс импорта

### Вариант 1: Автоматический импорт (рекомендуется)

**Процесс**:
1. Подключение к WhatsApp Web через whatsapp-web.js
2. Получение списка всех чатов
3. Для каждого чата:
   - Извлечение контакта (имя, телефон)
   - Извлечение всех сообщений
   - Определение языка сообщений
   - Анализ контекста для определения статуса
4. Валидация и очистка данных
5. Импорт в БД с возможностью просмотра и корректировки

**Преимущества**:
- Автоматический процесс
- Меньше ручной работы
- Можно запустить несколько раз

**Недостатки**:
- Требует подключения к WhatsApp
- Может занять время (100 переписок)
- Нужна обработка ошибок

### Вариант 2: Ручной импорт через экспорт WhatsApp

**Процесс**:
1. Экспорт чатов из WhatsApp (через функцию экспорта)
2. Загрузка экспортированных файлов в систему
3. Парсинг экспортированных файлов
4. Валидация и импорт

**Преимущества**:
- Не требует подключения к WhatsApp
- Можно делать офлайн
- Более контролируемый процесс

**Недостатки**:
- Требует ручного экспорта из WhatsApp
- Формат экспорта может отличаться

### Вариант 3: Гибридный (рекомендуется для MVP)

**Процесс**:
1. Автоматическое извлечение данных через WhatsApp Web
2. Сохранение в промежуточный формат (JSON)
3. Ручной просмотр и корректировка данных
4. Импорт в БД

**Преимущества**:
- Автоматизация + контроль
- Можно корректировать данные перед импортом
- Можно запускать несколько раз

## Детальный процесс импорта

### Шаг 1: Подключение к WhatsApp

```typescript
// Используем существующий WhatsApp клиент
const whatsappClient = await connectWhatsApp(organizationId);
```

### Шаг 2: Извлечение чатов

```typescript
// Получаем все чаты
const chats = await whatsappClient.getChats();

// Фильтруем только чаты с сообщениями
const activeChats = chats.filter(chat => chat.unreadCount > 0 || chat.lastMessage);
```

### Шаг 3: Извлечение данных из каждого чата

Для каждого чата извлекаем:

**Контакт**:
- Имя (из контакта или из сообщений)
- Телефон (из ID чата)
- Аватар (опционально)

**Сообщения**:
- Текст сообщения
- Дата и время
- Отправитель (клиент/менеджер)
- Тип сообщения (текст/медиа/голосовое)
- Медиа файлы (если есть)

**Контекст**:
- Первое сообщение (для определения когда начался диалог)
- Последнее сообщение
- Количество сообщений
- Язык сообщений (определяется автоматически)

### Шаг 4: Определение статуса клиента

Анализируем контекст диалога для определения статуса. Доступны два метода:

#### Метод 1: Эвристический (по умолчанию)

Быстрый метод на основе ключевых слов и временных паттернов:

**Правила определения статуса**:
- `NEW_LEAD`: Первое сообщение недавно (< 7 дней), нет признаков квалификации
- `QUALIFIED`: Есть вопросы о датах, бюджете, количестве человек
- `PROPOSAL_SENT`: Упоминание конкретных туров, отправка информации о турах
- `SOLD`: Упоминание оплаты, подтверждение бронирования
- `SERVICE`: Сообщения во время тура или после тура
- `CLOSED`: Нет активности > 30 дней, или явный отказ

**Индикаторы для определения**:
- Ключевые слова (даты, бюджет, тур, оплата, бронирование)
- Структура диалога (вопросы → ответы → предложение → решение)
- Временные метки (когда было последнее сообщение)

#### Метод 2: LLM-based (опционально)

Более точный метод с использованием AI (OpenRouter GPT-4o-mini):

**Преимущества**:
- Анализирует полный контекст диалога
- Лучше понимает намерения и контекст
- Поддерживает множественные языки
- Автоматический fallback на эвристику при ошибках

**Требования**:
- OpenRouter API ключ
- Промпт STATUS_DETECTION агента в базе данных (создается через seed)
- Настройка `useLLMStatusDetection: true` в опциях импорта

**Использование**:
```typescript
const importService = new DataImportService(organizationId, undefined, {
  useLLMStatusDetection: true,
  openRouterApiKey: process.env.OPENROUTER_API_KEY!,
});

await importService.startImport({
  useLLMStatusDetection: true,
  // ... другие опции
});
```

### Шаг 5: Валидация данных

**Проверки**:
- Валидность телефона (формат +996XXXXXXXXX)
- Наличие имени или телефона
- Дубликаты (клиент с таким телефоном уже существует?)
- Конфликты (разные имена для одного телефона?)

### Шаг 6: Просмотр и корректировка (опционально)

**UI для просмотра**:
- Список извлеченных клиентов
- Предпросмотр данных каждого клиента
- Возможность редактирования перед импортом
- Возможность пропустить клиента

### Шаг 7: Импорт в БД

**Транзакционный импорт**:
- Создание клиента
- Создание разговора
- Создание сообщений (пакетами для производительности)
- Обновление статуса клиента
- Создание истории статусов

## API для импорта

### POST /api/import/whatsapp/start
Начать импорт данных из WhatsApp.

**Request**:
```json
{
  "organizationId": "uuid",
  "options": {
    "importContacts": true,
    "importMessages": true,
    "detectStatus": true,
    "useLLMStatusDetection": false,  // Использовать LLM-based детекцию (требует настройки)
    "skipDuplicates": true,
    "dryRun": false  // Если true, только извлечение без импорта
  }
}
```

**Response** (202 Accepted):
```json
{
  "importId": "uuid",
  "status": "RUNNING",
  "totalChats": 100,
  "processedChats": 0,
  "estimatedTime": "10 minutes"
}
```

### GET /api/import/whatsapp/:importId/status
Получить статус импорта.

**Response** (200 OK):
```json
{
  "importId": "uuid",
  "status": "RUNNING" | "COMPLETED" | "FAILED" | "PAUSED",
  "totalChats": 100,
  "processedChats": 45,
  "successfulImports": 42,
  "failedImports": 3,
  "skippedDuplicates": 5,
  "currentChat": "John Doe",
  "errors": [
    {
      "chat": "Jane Smith",
      "error": "Invalid phone number format"
    }
  ]
}
```

### GET /api/import/whatsapp/:importId/preview
Получить предпросмотр извлеченных данных (до импорта).

**Response** (200 OK):
```json
{
  "clients": [
    {
      "phone": "+996555123456",
      "name": "John Doe",
      "detectedLanguage": "en",
      "detectedStatus": "QUALIFIED",
      "messageCount": 25,
      "firstMessageDate": "2025-11-15T10:00:00Z",
      "lastMessageDate": "2025-12-18T14:30:00Z",
      "preview": "First message: Hello, I'm interested..."
    }
  ],
  "totalClients": 95,
  "totalMessages": 2500
}
```

### POST /api/import/whatsapp/:importId/execute
Выполнить импорт извлеченных данных.

**Request**:
```json
{
  "clientIds": ["uuid1", "uuid2"], // Опционально: импортировать только выбранных
  "skipDuplicates": true,
  "updateExisting": false  // Обновлять существующих клиентов?
}
```

### POST /api/import/whatsapp/:importId/cancel
Отменить импорт.

## UI для импорта

### Компонент Import Wizard

**Шаги**:
1. **Подключение**: Подключение к WhatsApp Web (QR-код)
2. **Извлечение**: Прогресс извлечения данных (100 чатов)
3. **Просмотр**: Список извлеченных клиентов с возможностью редактирования
4. **Валидация**: Просмотр ошибок и предупреждений
5. **Импорт**: Подтверждение и запуск импорта
6. **Результат**: Статистика импорта

## Обработка ошибок

### Типы ошибок

1. **Ошибки подключения**:
   - WhatsApp не подключен
   - Разрыв соединения во время импорта
   - Решение: Переподключение, возобновление с места остановки

2. **Ошибки извлечения**:
   - Не удалось получить чат
   - Не удалось получить сообщения
   - Решение: Пропустить проблемный чат, логировать ошибку

3. **Ошибки валидации**:
   - Невалидный телефон
   - Отсутствует имя
   - Решение: Показать в UI для ручной корректировки

4. **Ошибки импорта**:
   - Дубликат клиента
   - Ошибка БД
   - Решение: Пропустить или обновить существующего клиента

## Производительность

### Оптимизация

- **Пакетная обработка**: Обработка чатов пакетами (по 10)
- **Параллельная обработка**: Обработка нескольких чатов одновременно
- **Кэширование**: Кэширование извлеченных данных перед импортом
- **Прогресс**: Отображение прогресса для пользователя

### Оценка времени

- **Извлечение**: ~1-2 секунды на чат = 100-200 секунд для 100 чатов (~2-3 минуты)
- **Парсинг**: ~0.5 секунды на чат = 50 секунд
- **Импорт**: ~0.5 секунды на клиента = 50 секунд
- **Итого**: ~5-7 минут для 100 переписок

## Безопасность

- **Изоляция данных**: Импорт только для своей организации
- **Валидация**: Проверка прав доступа перед импортом
- **Логирование**: Логирование всех операций импорта
- **Откат**: Возможность откатить импорт (опционально)

## Тестирование

### Unit тесты

- Тесты парсеров (определение языка, статуса)
- Тесты валидаторов
- Тесты импортеров

### Integration тесты

- Тесты с реальными данными WhatsApp (test account)
- Тесты обработки ошибок
- Тесты производительности

## Ограничения MVP

- **Только WhatsApp**: Другие источники данных (Telegram, CSV, Email) - post-MVP
- **Простой парсинг**: Базовое определение статуса, расширенный AI-анализ - post-MVP
- **Ручная корректировка**: Автоматическая корректировка ошибок - post-MVP
- **Один раз**: Импорт для первоначальной загрузки, инкрементальный импорт - post-MVP

## Архитектурное расширение

Модуль спроектирован с учетом будущего расширения:

**Абстракция DataExtractor**:
```typescript
interface DataExtractor {
  extractContacts(): Promise<Contact[]>;
  extractMessages(contactId: string): Promise<Message[]>;
  extractMedia(messageId: string): Promise<Media[]>;
}
```

**Реализации**:
- `WhatsAppExtractor` - для MVP (реализуется первым)
- `TelegramExtractor` - post-MVP
- `CSVExtractor` - post-MVP
- `EmailExtractor` - post-MVP

Это позволяет легко добавлять новые источники данных в будущем без изменения основной логики импорта.

## Следующие шаги

1. **Реализация модуля**:
   - Создать структуру модуля data-import
   - Реализовать extractor для WhatsApp
   - Реализовать parser для определения статуса
   - Реализовать importer для БД

2. **Тестирование**:
   - Тестирование на небольшом количестве чатов (5-10)
   - Проверка качества извлечения данных
   - Проверка определения статусов

3. **Импорт реальных данных**:
   - Запуск импорта для всех 100 переписок
   - Ручная проверка и корректировка
   - Использование как seed данных

---

**Версия**: 1.0  
**Дата создания**: 2025-12-20  
**Последнее обновление**: 2025-12-20  
**Статус**: Модуль 0 - Pre-MVP

