# Стратегия обновления культурного контекста

## Когда обновлять культурный контекст

### При импорте (первичная загрузка)
- **Всегда** определяем культурный контекст через LLM
- Используем все доступные сообщения для анализа

### При новых сообщениях (runtime)

**Автоматическое обновление происходит если:**

1. **Клиент новый** (нет `culturalContext`)
   - ✅ Всегда определяем при первом сообщении

2. **Язык изменился** (был русский, стал английский)
   - ✅ Обновляем, так как может указывать на другую культурную группу

3. **Недостаточно данных** (< 5 сообщений было при первом определении)
   - ✅ Обновляем при появлении новых сообщений для более точного определения

4. **Прошло много времени** (>30 дней с последнего обновления)
   - ✅ Обновляем для актуализации контекста

5. **Низкая уверенность** (confidence < 0.6)
   - ✅ Обновляем при появлении новых данных

**Не обновляем если:**
- Прошло <7 дней с последнего обновления И confidence >= 0.7
- Язык не изменился и нет новых культурных маркеров

## Как обновлять

### Вариант 1: При каждом статус-детекции (рекомендуется)
- Когда вызываем LLM для определения статуса, также получаем культурный контекст
- Проверяем `shouldUpdateCulturalContext()` перед обновлением
- Если нужно обновить → используем новый контекст из LLM
- Если не нужно → оставляем старый

### Вариант 2: Периодическое обновление
- Раз в неделю/месяц переоценивать клиентов с низкой уверенностью
- Фоновая задача для улучшения качества данных

### Вариант 3: Ручное обновление
- Менеджер может запросить обновление культурного контекста
- Полезно если клиент явно упомянул страну/происхождение

## Реализация

### Функция проверки необходимости обновления

```typescript
import { shouldUpdateCulturalContext } from '@soul-kg-crm/data-import';

const shouldUpdate = shouldUpdateCulturalContext({
  currentCulturalContext: client.culturalContext,
  currentLanguage: client.preferredLanguage,
  newLanguage: detectedLanguage,
  messageCount: messages.length,
  daysSinceLastUpdate: daysSince(client.metadata?.culturalContextUpdatedAt),
  hasNewMessages: true,
});

if (shouldUpdate) {
  // Вызываем LLM для обновления
  const statusResult = await statusDetector.detectStatus(...);
  if (statusResult.culturalContext) {
    // Обновляем культурный контекст
    await updateClientCulturalContext(client.id, statusResult.culturalContext);
  }
}
```

### Обновление в БД

```typescript
await prisma.client.update({
  where: { id: clientId },
  data: {
    culturalContext: newCulturalContext,
    metadata: {
      ...client.metadata,
      culturalContextUpdatedAt: new Date().toISOString(),
      culturalContextUpdateReason: 'new_messages' | 'language_changed' | 'periodic',
    },
  },
});
```

## Интеграция в обработку сообщений

Когда приходит новое сообщение:

1. Определяем язык сообщения
2. Проверяем необходимость обновления культурного контекста
3. Если нужно → вызываем LLM (вместе со статусом)
4. Обновляем культурный контекст в БД
5. Используем обновленный контекст для агентов

## Примеры сценариев

### Сценарий 1: Новый клиент
- Первое сообщение на английском, телефон +971
- LLM определяет: likelyOrigin: "India", region: "South Asia", formal style
- ✅ Сохраняем

### Сценарий 2: Изменение языка
- Было: русский язык → определен как "Russia"
- Стало: английский язык
- ✅ Обновляем: LLM переанализирует и может определить "India" или "Pakistan"

### Сценарий 3: Накопление данных
- Было: 2 сообщения → низкая уверенность (0.5)
- Стало: 10 сообщений → больше данных для анализа
- ✅ Обновляем для повышения точности

### Сценарий 4: Стабильный контекст
- Определен с высокой уверенностью (0.9)
- Прошло 3 дня, язык не изменился
- ❌ Не обновляем (экономия ресурсов)


