# Подход к импорту данных из WhatsApp

> **Версия**: 1.0  
> **Дата создания**: 2025-12-20  
> **Последнее обновление**: 2025-12-20

## Как это будет работать

### Вариант 1: Автоматический импорт через whatsapp-web.js (РЕКОМЕНДУЕТСЯ)

**Процесс**:
1. Разрабатываем модуль импорта данных (`packages/data-import/`)
2. Модуль использует whatsapp-web.js для подключения к WhatsApp Web
3. После подключения модуль:
   - Получает список всех чатов (`client.getChats()`)
   - Для каждого чата извлекает:
     - Контакт (имя, телефон)
     - Все сообщения (`chat.fetchMessages()`)
     - Медиа файлы (если есть)
4. Парсит данные и определяет статусы клиентов
5. Импортирует в БД

**Преимущества**:
- ✅ Полностью автоматический процесс
- ✅ Не требует ручного экспорта из WhatsApp
- ✅ Можно запустить несколько раз
- ✅ Использует ту же инфраструктуру что и основная система

**Недостатки**:
- ⚠️ Требует подключения к WhatsApp (QR-код)
- ⚠️ Может занять время (~5-7 минут для 100 чатов)
- ⚠️ Нужна обработка ошибок и переподключений

**Реализация**:
```typescript
// Псевдокод процесса импорта

async function importWhatsAppData(organizationId: string) {
  // 1. Подключение к WhatsApp
  const client = await connectWhatsApp(organizationId);
  
  // 2. Получение всех чатов
  const chats = await client.getChats();
  console.log(`Найдено ${chats.length} чатов`);
  
  // 3. Обработка каждого чата
  for (const chat of chats) {
    try {
      // Извлечение контакта
      const contact = await chat.getContact();
      const phone = contact.number;
      const name = contact.pushname || contact.name || phone;
      
      // Извлечение сообщений
      const messages = await chat.fetchMessages({ limit: 1000 });
      
      // Парсинг данных
      const clientData = {
        phone,
        name,
        messages: messages.map(msg => ({
          content: msg.body,
          date: msg.timestamp,
          fromMe: msg.fromMe,
          // ...
        })),
        detectedLanguage: detectLanguage(messages),
        detectedStatus: detectStatus(messages)
      };
      
      // Валидация
      if (validateClientData(clientData)) {
        // Импорт в БД
        await importClient(clientData, organizationId);
      }
    } catch (error) {
      console.error(`Ошибка при обработке чата ${chat.id}:`, error);
      // Продолжаем со следующим чатом
    }
  }
}
```

### Вариант 2: Ручной импорт через экспорт WhatsApp

**Процесс**:
1. Вы экспортируете чаты из WhatsApp (через настройки WhatsApp)
2. Загружаете экспортированные файлы в систему
3. Система парсит файлы и импортирует данные

**Недостатки**:
- Требует ручного экспорта из WhatsApp
- Формат экспорта может отличаться
- Менее автоматизировано

## Рекомендуемый подход

**Используем Вариант 1 (автоматический импорт)**:
- Это правильный подход для модуля импорта
- Использует ту же инфраструктуру что и основная система
- Можно реализовать как отдельный модуль перед основной разработкой

## План реализации модуля импорта

### Шаг 1: Создать базовую структуру модуля (1-2 часа)

```
packages/data-import/
├── src/
│   ├── extractors/
│   │   └── whatsapp-extractor.ts
│   ├── parsers/
│   │   ├── status-detector.ts
│   │   └── language-detector.ts
│   ├── validators/
│   │   └── data-validator.ts
│   ├── importers/
│   │   └── db-importer.ts
│   └── index.ts
└── tests/
```

### Шаг 2: Реализовать WhatsApp extractor (2-3 часа)

- Подключение к WhatsApp через whatsapp-web.js
- Получение списка чатов
- Извлечение контактов и сообщений
- Обработка ошибок

### Шаг 3: Реализовать парсеры (2-3 часа)

- Определение языка сообщений
- Определение статуса клиента на основе контекста
- Извлечение структурированных данных

### Шаг 4: Реализовать валидатор и importer (2-3 часа)

- Валидация данных
- Обнаружение дубликатов
- Импорт в БД

### Шаг 5: Тестирование и импорт реальных данных (1-2 часа)

- Тестирование на небольшом количестве чатов
- Импорт всех ~100 переписок
- Валидация результатов

**Итого**: ~8-13 часов работы (1-2 дня)

## Когда запускать импорт?

**Вариант A: До начала разработки (рекомендуется)**
- Реализуем модуль импорта первым
- Импортируем данные
- Используем как seed данные для разработки

**Вариант B: Параллельно с разработкой**
- Начинаем разработку основной системы
- Параллельно разрабатываем модуль импорта
- Импортируем данные когда модуль готов

**Рекомендация**: Вариант A - реализовать модуль импорта первым, чтобы сразу работать с реальными данными.

## Что нужно от вас?

1. **Доступ к WhatsApp**: 
   - Нужен доступ к WhatsApp аккаунту Soul KG
   - Нужно будет отсканировать QR-код для подключения

2. **Проверка данных**:
   - После импорта нужно будет проверить данные
   - Возможно потребуется ручная корректировка некоторых клиентов

3. **Продукты/Туры**:
   - Список продуктов с датами (когда будете готовы)
   - Это можно добавить вручную после импорта клиентов

## Вопросы для уточнения

1. **Доступ к WhatsApp**: 
   - У вас есть доступ к WhatsApp аккаунту Soul KG?
   - Можете ли вы отсканировать QR-код для подключения?

2. **Приоритет**:
   - Делаем модуль импорта первым (Модуль 0)?
   - Или начинаем основную разработку и импорт делаем параллельно?

3. **Данные**:
   - Все ~100 переписок в одном WhatsApp аккаунте?
   - Или данные разбросаны по разным аккаунтам?

---

**Рекомендация**: Реализовать модуль импорта как **Модуль 0** (первым), чтобы сразу работать с реальными данными при разработке основной системы.

