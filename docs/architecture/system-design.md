# Системная архитектура: Soul KG CRM

> **Версия**: 1.1  
> **Дата создания**: 2025-12-20  
> **Последнее обновление**: 2025-12-20  
> **Статус**: MVP System Design (обновлено: мониторинг, backup, seed данные)

## 1. Обзор архитектуры

### 1.1 Назначение

Soul KG CRM - это коммерческая мультитенантная SaaS CRM система с AI-агентами для автоматизации продаж туров через WhatsApp. Система обеспечивает изоляцию данных между организациями, автоматизацию общения с клиентами через AI-агентов и управление воронкой продаж.

### 1.2 Архитектурный стиль

- **Монолитная архитектура** (MVP) с четким разделением на слои
- **Мультитенантность**: Изоляция данных на уровне БД (RLS) и приложения (tenant_id)
- **Микросервисная готовность**: Компоненты спроектированы для будущего разделения на микросервисы

### 1.3 Высокоуровневая диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend Layer                        │
│                    (Next.js App Router)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Dashboard  │  │   Clients    │  │   Settings   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└───────────────────────────┬─────────────────────────────────┘
                            │ HTTP/REST
┌───────────────────────────▼─────────────────────────────────┐
│                      Backend API Layer                       │
│              (Node.js + Express/Fastify)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Auth API   │  │  Clients API│  │  Agents API  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└───────────┬───────────────────┬───────────────────┬───────┘
            │                   │                   │
    ┌───────▼───────┐  ┌───────▼───────┐  ┌───────▼───────┐
    │   PostgreSQL  │  │   WhatsApp    │  │  AI Orchestrator│
    │   + pgvector  │  │   Web Client  │  │  (LangChain)    │
    └───────────────┘  └───────────────┘  └─────────────────┘
            │                   │                   │
    ┌───────▼───────┐  ┌───────▼───────┐  ┌───────▼───────┐
    │   BullMQ      │  │  Translation  │  │  Analysis     │
    │   Queue       │  │  Service      │  │  Service      │
    └───────────────┘  └───────────────┘  └─────────────────┘
```

## 2. Архитектурные принципы

### 2.1 Мультитенантность

**Принцип**: Все данные изолированы по организациям с самого начала

**Реализация**:
- `tenant_id` (organization_id) во всех таблицах БД
- Row Level Security (RLS) в PostgreSQL для гарантии изоляции
- Фильтрация запросов на уровне приложения
- Изоляция сессий WhatsApp по организациям
- Изоляция промптов и конфигураций AI-агентов

### 2.2 Масштабируемость

**Принцип**: Архитектура готова к горизонтальному масштабированию

**Реализация**:
- Stateless backend (сессии в БД или Redis)
- Очереди для асинхронной обработки (BullMQ)
- Готовность к разделению на микросервисы
- Кэширование на уровне приложения (Redis опционально)

### 2.3 Безопасность

**Принцип**: Многоуровневая защита данных

**Реализация**:
- JWT токены для аутентификации
- RLS политики в PostgreSQL
- Валидация tenant_id на уровне API
- HTTPS для всех соединений
- Изоляция сессий WhatsApp

### 2.4 Надежность

**Принцип**: Система должна быть устойчива к сбоям

**Реализация**:
- Очереди для обработки сообщений (BullMQ с retry)
- Автоматическое переподключение WhatsApp
- Транзакции БД для критичных операций
- Логирование и мониторинг

## 3. Компоненты системы

### 3.1 Frontend Layer

**Технология**: Next.js 14+ (App Router)

**Компоненты**:
- **Dashboard**: Статистика, метрики, уведомления
- **Clients Management**: Список клиентов, профили, история общения
- **Conversations**: Интерфейс общения с клиентами (с переводчиком)
- **Products Management**: Управление продуктами/турами
- **Partners Management**: Управление партнерами
- **Agents Configuration**: Настройка AI-агентов, промптов
- **Experiments**: Управление A/B тестированием промптов
- **Analytics**: Аналитика и метрики
- **Settings**: Настройки организации

**Особенности**:
- Server Components для SEO и производительности
- Client Components для интерактивности
- Real-time обновления через WebSocket или polling
- Многоязычный интерфейс (русский, английский)

### 3.2 Backend API Layer

**Технология**: Node.js + TypeScript + Express/Fastify

**Структура**:
```
packages/
├── api/                    # REST API
│   ├── routes/            # Маршруты API
│   │   ├── auth.ts
│   │   ├── clients.ts
│   │   ├── conversations.ts
│   │   ├── messages.ts
│   │   ├── products.ts
│   │   ├── partners.ts
│   │   ├── agents.ts
│   │   ├── experiments.ts
│   │   └── whatsapp.ts
│   ├── middleware/        # Middleware
│   │   ├── auth.ts        # JWT аутентификация
│   │   ├── tenant.ts      # Изоляция по tenant_id
│   │   └── validation.ts  # Валидация запросов
│   └── controllers/      # Контроллеры
├── database/              # Prisma схема и миграции
├── whatsapp/              # WhatsApp интеграция
├── agents/                # AI агенты
├── queue/                 # BullMQ очереди
└── shared/                # Общие утилиты
```

**API Endpoints** (детали в api-contracts.md):
- `/api/auth/*` - Аутентификация
- `/api/clients/*` - Управление клиентами
- `/api/conversations/*` - Управление разговорами
- `/api/messages/*` - Управление сообщениями
- `/api/products/*` - Управление продуктами
- `/api/partners/*` - Управление партнерами
- `/api/agents/*` - Управление AI-агентами
- `/api/experiments/*` - Управление экспериментами
- `/api/whatsapp/*` - Управление WhatsApp интеграцией
- `/api/analytics/*` - Аналитика и метрики

### 3.3 Database Layer

**Технология**: PostgreSQL 15+ с расширением pgvector

**Особенности**:
- Мультитенантность через tenant_id и RLS
- Индексы для производительности
- pgvector для векторного поиска (будущее: RAG для AI)
- Миграции через Prisma

**Основные таблицы** (детали в database-schema.md):
- `organizations` - Организации (tenants)
- `users` - Пользователи организаций
- `clients` - Клиенты
- `conversations` - Разговоры
- `messages` - Сообщения
- `client_status_history` - История статусов
- `products` - Продукты/туры
- `partners` - Партнеры
- `agent_configurations` - Конфигурации AI-агентов
- `prompt_variants` - Варианты промптов для A/B тестирования
- `experiments` - Эксперименты
- `dialogue_analysis` - Результаты анализа диалогов

### 3.4 WhatsApp Integration Layer

**Технология**: whatsapp-web.js

**Компоненты**:
- **WhatsApp Client Manager**: Управление клиентами для каждой организации
- **Session Manager**: Сохранение и восстановление сессий
- **Message Handler**: Обработка входящих и исходящих сообщений
- **Queue Integration**: Интеграция с BullMQ для очередей сообщений

**Архитектура** (детали в integrations.md):
```
WhatsApp Web Client (per organization)
    ↓
Message Queue (BullMQ)
    ↓
Message Handler
    ↓
AI Orchestrator / Human Handler
    ↓
Database
```

**Особенности**:
- Одна сессия WhatsApp на организацию
- QR-код для авторизации (отображается в UI)
- Автоматическое переподключение при разрыве
- Rate limiting через очереди (~20 сообщений/мин)
- Обнаружение сообщений от менеджера (`fromMe === true`)

### 3.5 AI Orchestrator Layer

**Технология**: LangChain/LangGraph

**Компоненты**:
- **Agent Orchestrator**: Центральный оркестратор для выполнения агентов
- **Agent Registry**: Реестр доступных агентов
- **Prompt Manager**: Управление промптами (с tenant_id)
- **Context Manager**: Управление контекстом диалогов

**Архитектура агентов**:
```
Agent Configuration (DB)
    ↓
Agent Orchestrator
    ↓
LangChain/LangGraph
    ↓
LLM Provider (OpenAI/Anthropic/Ollama)
    ↓
Response → Message Queue → WhatsApp
```

**Типы агентов**:
- **Communication Agent**: Базовый агент общения
- **Qualification Agent**: Квалификация лидов
- **Product Selection Agent**: Подбор туров
- **Translation Agent**: Определение языка и перевод

**Особенности**:
- Промпты хранятся в БД с tenant_id
- Конфигурации агентов изолированы по организациям
- Поддержка A/B тестирования промптов
- Контекст диалога передается между агентами

### 3.6 Queue Layer

**Технология**: BullMQ + Redis

**Очереди**:
- **message-send**: Отправка сообщений через WhatsApp
- **message-process**: Обработка входящих сообщений
- **agent-execution**: Выполнение AI-агентов
- **translation**: Перевод сообщений
- **analysis**: Анализ диалогов (post-MVP)

**Особенности**:
- Rate limiting для WhatsApp
- Retry механизм для failed jobs
- Приоритеты для критичных задач
- Мониторинг через Bull Board

### 3.7 Translation Service

**Технология**: Google Translate API / DeepL API

**Функции**:
- Определение языка входящего сообщения
- Перевод сообщений клиента для менеджера
- Перевод ответов менеджера на язык клиента
- Контекстуальный перевод (туристическая терминология)

**Поддерживаемые языки (MVP)**:
- Английский, русский, арабский, французский, немецкий, испанский, польский

### 3.8 Analysis Service (Post-MVP)

**Технология**: LLM для анализа диалогов

**Функции**:
- Анализ успешных диалогов
- Выявление паттернов
- Генерация рекомендаций по улучшению промптов
- Автоматическая генерация вариантов промптов

## 4. Взаимодействие компонентов

### 4.1 Поток обработки входящего сообщения

```
1. WhatsApp Web получает сообщение
   ↓
2. Message Handler сохраняет в БД
   ↓
3. Message Queue (message-process)
   ↓
4. Определение языка (Translation Service)
   ↓
5. AI Orchestrator выбирает агента
   ↓
6. Агент генерирует ответ (LLM)
   ↓
7. Message Queue (message-send)
   ↓
8. Отправка через WhatsApp Web
```

### 4.2 Поток переключения на менеджера

```
1. Менеджер берет диалог (через CRM или WhatsApp)
   ↓
2. Система обнаруживает вмешательство
   ↓
3. AI Orchestrator прекращает автоматические ответы
   ↓
4. Менеджер видит оригинал + перевод сообщения
   ↓
5. Менеджер пишет ответ на своем языке
   ↓
6. Translation Service переводит ответ
   ↓
7. Отправка через WhatsApp Web
```

### 4.3 Поток A/B тестирования

```
1. Админ создает варианты промптов
   ↓
2. Система назначает вариант клиенту
   ↓
3. AI Orchestrator использует назначенный вариант
   ↓
4. Система собирает метрики конверсии
   ↓
5. Analysis Service анализирует результаты
   ↓
6. Админ получает рекомендации
```

## 5. Мультитенантность

### 5.1 Изоляция данных

**Уровень БД**:
- `tenant_id` (organization_id) во всех таблицах
- RLS политики в PostgreSQL
- Индексы на tenant_id для производительности

**Уровень приложения**:
- Middleware для автоматической фильтрации по tenant_id
- Валидация tenant_id в контроллерах
- Изоляция сессий WhatsApp по организациям

**Уровень AI**:
- Промпты и конфигурации агентов с tenant_id
- Изоляция контекста диалогов по организациям

### 5.2 Управление сессиями

- Каждая организация имеет свою сессию WhatsApp
- Сессии хранятся изолированно (`.whatsapp-sessions/org-{id}/`)
- Переподключение при разрыве сессии

## 6. Масштабируемость

### 6.1 Горизонтальное масштабирование

**Backend API**:
- Stateless серверы
- Сессии в БД или Redis
- Load balancer для распределения нагрузки

**Queue Workers**:
- Множественные воркеры для обработки очередей
- Автоматическое распределение задач

**Database**:
- Read replicas для чтения
- Connection pooling
- Индексы для производительности

### 6.2 Вертикальное масштабирование

- Увеличение ресурсов серверов
- Оптимизация запросов к БД
- Кэширование часто используемых данных

## 7. Безопасность

### 7.1 Аутентификация

- JWT токены для аутентификации
- Refresh tokens для обновления сессий
- Пароли хешируются (bcrypt)

### 7.2 Авторизация

- Роли: супер-админ, админ организации, менеджер продаж
- Права доступа на уровне API
- RLS политики в БД

### 7.3 Изоляция данных

- RLS политики гарантируют изоляцию
- Валидация tenant_id на всех уровнях
- HTTPS для всех соединений

### 7.4 Защита от атак

- Rate limiting на уровне API
- Валидация всех входных данных
- SQL injection защита через Prisma
- XSS защита на уровне React

## 8. Мониторинг и логирование

### 8.1 Логирование

- Структурированные логи (JSON)
- Уровни: error, warn, info, debug
- Контекст: tenant_id, user_id, request_id, trace_id
- Хранение: минимум 30 дней
- Формат: JSON для удобного парсинга

**Инструменты**:
- Структурированные логи в файлы/стандартный вывод
- Sentry для ошибок и исключений
- Health check endpoints для проверки состояния системы

### 8.2 Мониторинг

**Инструменты**:
- **Sentry**: Отслеживание ошибок и исключений
- **Структурированные логи**: Базовые метрики в логах (для MVP)
- **Health check endpoints**: Проверка состояния системы

**Метрики производительности**:
- Response time API endpoints (средний, p95, p99)
- Throughput (запросов в секунду)
- Время выполнения AI-агентов
- Время обработки сообщений в очереди
- Использование токенов LLM

**Метрики очередей**:
- Queue length (длина очереди)
- Processing time (время обработки)
- Failed jobs (неудачные задачи)
- Retry count (количество повторов)

**Метрики WhatsApp**:
- Connection status (подключено/отключено)
- Message rate (сообщений в минуту)
- Failed messages (неудачные сообщения)
- Reconnection attempts (попытки переподключения)

**Метрики AI**:
- Agent execution time (время выполнения агента)
- Token usage (использование токенов)
- Success rate (процент успешных выполнений)
- Error rate (процент ошибок)

**Инструменты**:
- Sentry для ошибок и трейсинга
- Структурированные логи для метрик
- Prometheus/Grafana опционально (post-MVP)

### 8.3 Алерты

**Канал алертов**: Telegram (основной), Email (опционально)

**Пороги алертов**:
- **Критичные ошибки**: error rate > 5% за 5 минут
- **Разрыв WhatsApp**: disconnect > 5 минут
- **Высокая нагрузка на очередь**: queue length > 100 сообщений
- **Проблемы с БД**: response time > 2 секунд
- **Превышение лимитов LLM**: token usage > 80% лимита

**Содержание алерта**:
- Тип события
- Время события
- Детали проблемы
- Ссылка на дашборд/логи
- Контекст: tenant_id, user_id, trace_id

## 9. Развертывание

### 9.1 Development

- Docker Compose для локальной разработки
- Hot reload для Frontend и Backend
- Локальная БД PostgreSQL
- Seed данные для разработки (см. `docs/development/seed-data.md`)

### 9.2 Production

- Docker контейнеры для всех сервисов
- Kubernetes для оркестрации (опционально)
- Managed PostgreSQL (например, Supabase, AWS RDS)
- Redis для очередей
- CDN для статических файлов

### 9.3 Backup и Disaster Recovery

**Backup стратегия**:
- Ежедневные полные backup БД (в 02:00 UTC)
- Хранение backup минимум 30 дней
- Backup хранятся в отдельном хранилище (облако или отдельный сервер)
- Инструменты: pg_dump для PostgreSQL, автоматизация через cron/scheduled tasks

**Disaster Recovery**:
- RTO (Recovery Time Objective): 4 часа
- RPO (Recovery Point Objective): 24 часа (максимальная потеря данных - 1 день)
- Тестовое восстановление минимум раз в квартал
- Документированный план действий при полном сбое системы

## 10. Ограничения и риски

### 10.1 WhatsApp Web

- ⚠️ Не официальный API (риск изменений)
- ⚠️ Rate limits (~20 сообщений/мин)
- ⚠️ Риск блокировки при злоупотреблении
- ⚠️ Требуется QR-код для авторизации

### 10.2 Масштабирование

- Одна сессия WhatsApp на организацию
- Ограничения по количеству одновременных переписок
- Необходимость оптимизации запросов к БД

### 10.3 AI-агенты

- Зависимость от внешних LLM провайдеров
- Стоимость токенов
- Latency при генерации ответов

## 11. Будущие улучшения

### 11.1 Микросервисная архитектура

- Разделение на отдельные сервисы:
  - Auth Service
  - Clients Service
  - WhatsApp Service
  - AI Service
  - Analytics Service

### 11.2 Дополнительные каналы

- Telegram Bot API
- WhatsApp Business API (когда будет доступен)
- Email интеграция

### 11.3 Расширенная аналитика

- Real-time аналитика
- Прогнозирование конверсии
- Рекомендательная система

---

**Следующие шаги**:
1. Детализация схемы БД (database-schema.md)
2. Определение API контрактов (api-contracts.md)
3. Детализация интеграций (integrations.md)

