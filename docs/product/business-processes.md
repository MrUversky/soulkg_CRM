# Бизнес-процессы: Soul KG CRM

> **Версия**: 1.2  
> **Дата создания**: 2025-12-20  
> **Последнее обновление**: 2025-12-20  
> **Статус**: MVP Business Processes

## 1. Обзор процессов

Система поддерживает следующие основные бизнес-процессы:

1. **Работа с новым лидом** - от первого сообщения до квалификации
2. **Подбор тура** - предложение подходящих туров на основе потребностей клиента
3. **Передача партнеру** - передача клиента партнеру для исполнения тура
4. **Импорт данных** - перенос существующих данных из WhatsApp в CRM
5. **Переключение AI ↔ Человек** - гибкое переключение между автоматическим и ручным общением
6. **Экспериментирование с диалогами** - A/B тестирование промптов для улучшения конверсии
7. **Анализ и улучшение диалогов** - анализ успешных паттернов и генерация рекомендаций

## 2. Детальное описание процессов

### 2.1 Процесс работы с новым лидом

**Название**: Работа с новым лидом  
**Участники**: Клиент, AI-агент квалификации, Менеджер продаж  
**Триггер**: Клиент отправляет первое сообщение в WhatsApp

**Шаги процесса**:

1. **Получение сообщения**
   - Клиент отправляет сообщение в WhatsApp
   - Система получает сообщение через whatsapp-web.js
   - Система определяет язык сообщения автоматически

2. **Создание клиента**
   - Если клиент не существует в системе, создается новый клиент
   - Клиент получает статус `new_lead`
   - Сохраняется предпочтительный язык клиента
   - Сообщение сохраняется в истории общения

3. **Начало диалога AI-агентом**
   - AI-агент общения начинает диалог с клиентом
   - AI-агент отвечает на языке клиента
   - AI-агент использует тон и стиль организации

4. **Квалификация лида**
   - AI-агент квалификации задает вопросы из анкеты:
     - Даты поездки (точные/окно)
     - Количество человек (pax), возраст, состав
     - Уровень активности (легко/средне/без хайков)
     - Что важнее (природа/культура/фото-контент/тишина/комфорт/местная еда)
     - Бюджетный коридор
     - Пожелания по питанию (в т.ч. халяль)
     - Чувствительные моменты (холод/дороги/высота/страхи/ограничения)
   - Ответы сохраняются в профиле клиента
   - AI-агент учитывает культурный контекст клиента

5. **Обновление статуса**
   - При успешной квалификации статус автоматически обновляется на `qualified`
   - Менеджер получает уведомление о квалифицированном лиде

6. **Эскалация (если нужно)**
   - Если клиент просит поговорить с человеком
   - Если AI не может ответить на вопрос
   - Если клиент недоволен
   - → Процесс переходит к "Переключение AI ↔ Человек"

**Результаты**:
- Клиент квалифицирован
- Профиль клиента заполнен данными квалификации
- Статус клиента обновлен на `qualified`
- Менеджер уведомлен

**Исключения**:
- Если клиент не отвечает в течение 24 часов, статус остается `new_lead`
- Если менеджер вмешивается в диалог, процесс переходит к менеджеру
- Если клиент запрашивает немедленную передачу менеджеру, процесс переходит к менеджеру
- Если язык клиента не поддерживается, AI отвечает на английском с извинением

**Метрики процесса**:
- Время от первого сообщения до квалификации
- Процент успешно квалифицированных лидов
- Количество вопросов до квалификации

### 2.2 Процесс подбора тура

**Название**: Подбор тура для клиента  
**Участники**: Клиент, AI-агент подбора тура, Менеджер продаж  
**Триггер**: Клиент квалифицирован (статус `qualified`)

**Шаги процесса**:

1. **Анализ данных квалификации**
   - AI-агент анализирует данные квалификации клиента
   - Учитываются все параметры: даты, количество человек, уровень активности, бюджет, предпочтения

2. **Выбор подходящих туров**
   - AI-агент выбирает подходящие туры из базы продуктов организации
   - Критерии подбора:
     - Соответствие датам
     - Соответствие количеству человек
     - Соответствие уровню активности
     - Соответствие бюджету
     - Соответствие предпочтениям (природа/культура/фото и т.д.)

3. **Предложение туров**
   - AI-агент предлагает 1-2 варианта туров клиенту
   - Описание туров на языке клиента
   - Объяснение различий между вариантами:
     - "больше культуры vs больше зимних активностей"
     - "больше южного берега/каньонов vs Каракол/Жыргалан"
     - "больше коней/юрты vs город/локальные рестораны"

4. **Уточнение деталей**
   - AI-агент уточняет детали:
     - Опции (баня, снегоходы, орлы и т.д.)
     - Питание (халяль, аллергии)
     - Особые пожелания
   - AI-агент честно проговаривает ограничения (погода, дороги, физнагрузка)

5. **Формирование заказ-карты**
   - AI-агент формирует "заказ-карту" с полной информацией:
     - Даты поездки
     - Количество человек (pax)
     - Выбранный тур
     - Предпочтения клиента
     - Питание
     - Темп (неспешный/активный)
     - Private формат или нет
     - Пожелания по контенту
   - Заказ-карта сохраняется в профиле клиента

6. **Уведомление менеджера**
   - Менеджер получает уведомление о готовом заказе
   - Статус клиента обновляется на `proposal_sent` или `negotiation`

**Результаты**:
- Клиент выбрал тур
- Сформирована заказ-карта с полной информацией
- Статус клиента обновлен на `proposal_sent` или `negotiation`
- Менеджер уведомлен

**Исключения**:
- Если клиент не выбирает тур в течение 48 часов, менеджер получает уведомление для ручного вмешательства
- Если клиент запрашивает изменения, которые требуют согласования с партнером, процесс переходит к менеджеру
- Если менеджер вмешивается, процесс переходит к менеджеру

**Метрики процесса**:
- Время от квалификации до выбора тура
- Процент клиентов выбравших тур
- Количество предложенных вариантов до выбора

### 2.3 Процесс передачи партнеру

**Название**: Передача клиента партнеру для исполнения тура  
**Участники**: Менеджер продаж, Партнер, Клиент  
**Триггер**: Клиент выбрал тур и готов к передаче (статус `sold` или `negotiation`)

**Шаги процесса**:

1. **Выбор партнера**
   - Менеджер выбирает партнера из списка
   - Партнер определяется на основе выбранного тура (если тур привязан к партнеру)
   - Или менеджер выбирает партнера вручную

2. **Подготовка информации**
   - Система формирует информацию о клиенте:
     - Данные клиента (имя, телефон, email)
     - Выбранный тур
     - Предпочтения клиента (питание, активность, особые пожелания)
     - Даты поездки
     - Язык общения клиента
     - Культурный контекст (если применимо)

3. **Отправка информации партнеру**
   - Информация отправляется через выбранный канал:
     - WhatsApp (основной способ)
     - Telegram (опционально)
     - Email (опционально)
   - Информация отправляется на языке партнера или английском

4. **Обновление статуса**
   - Статус клиента обновляется на `service`
   - История передачи сохраняется в профиле клиента
   - Партнер привязывается к клиенту

5. **Подтверждение партнера**
   - Партнер подтверждает получение информации
   - Партнер может связаться с клиентом напрямую

**Результаты**:
- Партнер получил информацию о клиенте
- Статус клиента обновлен на `service`
- История передачи сохранена
- Партнер может связаться с клиентом

**Исключения**:
- Если партнер недоступен, менеджер получает уведомление
- Если партнер не отвечает, менеджер может выбрать другого партнера
- Если клиент передумал, статус можно вернуть обратно

**Метрики процесса**:
- Время от выбора тура до передачи партнеру
- Процент успешных передач
- Время ответа партнера

### 2.4 Процесс импорта данных из WhatsApp

**Название**: Импорт существующих данных из WhatsApp переписки  
**Участники**: Админ организации  
**Триггер**: Админ запускает процесс импорта

**Шаги процесса**:

1. **Экспорт данных из WhatsApp**
   - Админ экспортирует переписку из WhatsApp
   - Экспорт может быть в разных форматах (текст, JSON и т.д.)

2. **Загрузка данных в систему**
   - Админ загружает экспортированные данные в систему
   - Система начинает обработку данных

3. **Извлечение данных**
   - Система извлекает данные из неструктурированного текста:
     - Имя клиента (из контакта или сообщений)
     - Телефон
     - История сообщений
     - Контекст общения
   - Система определяет язык сообщений

4. **Парсинг и структурирование**
   - Система парсит неструктурированные данные
   - Система определяет статус клиента на основе контекста общения
   - Система группирует сообщения по клиентам

5. **Предпросмотр импортированных данных**
   - Админ просматривает импортированные данные перед сохранением
   - Система показывает:
     - Список найденных клиентов
     - Извлеченные данные для каждого клиента
     - Предполагаемый статус клиента
     - История сообщений

6. **Редактирование данных**
   - Админ может редактировать импортированные данные:
     - Исправить имя клиента
     - Добавить/изменить телефон
     - Изменить статус клиента
     - Удалить дубликаты
     - Объединить клиентов

7. **Сохранение данных**
   - Админ подтверждает импорт
   - Система создает клиентов в CRM
   - История общения сохраняется
   - Статусы клиентов устанавливаются

**Результаты**:
- Клиенты импортированы в CRM
- История общения сохранена
- Статусы клиентов установлены
- Данные готовы к использованию

**Исключения**:
- Если данные не могут быть извлечены, админ может импортировать вручную
- Если найдены дубликаты, админ может объединить их
- Если данные некорректны, админ может отредактировать их перед сохранением

**Метрики процесса**:
- Количество импортированных клиентов
- Процент успешно извлеченных данных
- Время импорта

### 2.5 Процесс переключения AI ↔ Человек

**Название**: Переключение между автоматическим и ручным общением  
**Участники**: Клиент, AI-агент, Менеджер продаж  
**Триггер**: Менеджер берет диалог ИЛИ клиент просит поговорить с человеком ИЛИ эскалация

**Шаги процесса**:

#### Вариант A: Менеджер берет диалог через CRM

1. **Инициация переключения**
   - Менеджер нажимает кнопку "Взять диалог" в интерфейсе CRM
   - AI-агент прекращает автоматические ответы
   - Статус диалога обновляется на "managed_by_human"

#### Вариант A2: Менеджер берет диалог через WhatsApp напрямую

1. **Обнаружение вмешательства**
   - Менеджер пишет клиенту напрямую через WhatsApp (минуя CRM)
   - Система обнаруживает сообщение от менеджера (`fromMe === true` в WhatsApp Web)
   - Система синхронизирует сообщение с CRM (сохраняет в историю общения)
   - AI-агент прекращает автоматические ответы для этого клиента
   - Статус диалога обновляется на "managed_by_human"

2. **Синхронизация**
   - Сообщение менеджера сохраняется в истории общения в CRM
   - Система фиксирует что ответ был через WhatsApp напрямую
   - Менеджер видит синхронизированное сообщение в CRM интерфейсе

3. **Продолжение диалога**
   - Менеджер может продолжать общение через WhatsApp или переключиться на CRM
   - Если менеджер пишет через CRM, система отправляет сообщение через WhatsApp
   - Если менеджер пишет через WhatsApp, сообщение синхронизируется с CRM
   - Система корректно обрабатывает оба канала одновременно

2. **Отображение контекста**
   - Менеджер видит:
     - Оригинальное сообщение клиента (на языке клиента)
     - Перевод сообщения на язык менеджера (если языки разные)
     - Всю историю диалога
     - Статус клиента
     - Культурные заметки (если применимо)

3. **Ответ менеджера**
   - Менеджер пишет ответ на своем языке (обычно русском)
   - Система автоматически переводит ответ на язык клиента
   - Менеджер может просмотреть перевод перед отправкой
   - Менеджер отправляет ответ клиенту

4. **Продолжение диалога**
   - Менеджер может продолжить общение с клиентом
   - Все сообщения переводятся автоматически
   - История показывает кто отвечал (AI или менеджер)

5. **Возврат к AI (опционально)**
   - Менеджер может вернуть диалог AI обратно
   - AI продолжает общение с учетом контекста диалога с менеджером

#### Вариант B: Клиент просит поговорить с человеком

1. **Запрос клиента**
   - Клиент явно просит поговорить с человеком
   - AI-агент определяет запрос и передает диалог менеджеру

2. **Уведомление менеджера**
   - Менеджер получает уведомление о запросе клиента
   - Уведомление показывает контекст диалога

3. **Переход к менеджеру**
   - Процесс продолжается как в Варианте A с шага 2

#### Вариант C: Эскалация

1. **Определение эскалации**
   - AI-агент определяет ситуацию требующую эскалации:
     - Клиент недоволен
     - Сложный вопрос, на который AI не может ответить
     - Критичная ситуация

2. **Автоматическая передача**
   - AI-агент автоматически передает диалог менеджеру
   - Менеджер получает уведомление с пометкой "Эскалация"

3. **Переход к менеджеру**
   - Процесс продолжается как в Варианте A с шага 2

**Результаты**:
- Диалог переключен на менеджера
- Менеджер может решить сложные вопросы
- Клиент получает персональное внимание
- История показывает кто отвечал

**Исключения**:
- Если менеджер недоступен, система может предложить клиенту подождать или оставить сообщение
- Если менеджер не отвечает в течение определенного времени, система может вернуть диалог AI

**Метрики процесса**:
- Количество переключений на менеджера
- Причины переключений
- Время ответа менеджера
- Процент возвратов к AI

### 2.6 Процесс подключения WhatsApp

**Название**: Подключение WhatsApp Web для организации  
**Участники**: Админ организации  
**Триггер**: Админ запускает подключение WhatsApp

**Шаги процесса**:

1. **Инициация подключения**
   - Админ нажимает кнопку "Подключить WhatsApp" в интерфейсе CRM
   - Система инициирует подключение через whatsapp-web.js

2. **Отображение QR-кода**
   - Система генерирует QR-код для авторизации
   - QR-код отображается в интерфейсе CRM
   - Админ сканирует QR-код через WhatsApp на телефоне

3. **Авторизация**
   - WhatsApp подтверждает авторизацию
   - Сессия сохраняется в системе
   - Система подтверждает успешное подключение

4. **Проверка подключения**
   - Система проверяет что подключение работает
   - Система может отправить тестовое сообщение

5. **Готовность к работе**
   - WhatsApp готов к получению и отправке сообщений
   - Система начинает слушать входящие сообщения

**Результаты**:
- WhatsApp подключен и готов к работе
- Сессия сохранена
- Система может получать и отправлять сообщения

**Исключения**:
- Если QR-код не сканируется, можно обновить QR-код
- Если авторизация не проходит, нужно повторить процесс
- Если сессия теряется, нужно переподключиться

**Метрики процесса**:
- Время подключения
- Процент успешных подключений
- Частота переподключений

## 3. Интеграция процессов

Процессы взаимодействуют следующим образом:

```
Новый лид → Квалификация → Подбор тура → Передача партнеру
     ↓            ↓              ↓              ↓
Переключение AI ↔ Человек (может произойти на любом этапе)
     ↓
Импорт данных (начальный этап, один раз)
     ↓
Экспериментирование с диалогами (постоянный процесс)
     ↓
Анализ и улучшение диалогов (циклический процесс улучшения)
```

**Ключевые точки интеграции**:

1. **Квалификация → Подбор тура**: После квалификации автоматически запускается процесс подбора тура
2. **Подбор тура → Передача партнеру**: После выбора тура клиентом запускается процесс передачи партнеру
3. **Переключение AI ↔ Человек**: Может произойти на любом этапе любого процесса
4. **Импорт данных**: Выполняется один раз при запуске системы, создает начальную базу клиентов
5. **Экспериментирование → Анализ**: Все диалоги используются для анализа и улучшения промптов
6. **Анализ → Экспериментирование**: Результаты анализа используются для создания новых вариантов промптов

## 4. Метрики процессов

### Общие метрики

- **Время обработки**: Среднее время от получения сообщения до ответа
- **Конверсия**: Процент лидов прошедших каждый этап воронки
- **Удовлетворенность**: Оценка клиентами качества общения (post-MVP)

### Метрики по процессам

- **Работа с лидом**: Время до квалификации, процент квалифицированных лидов
- **Подбор тура**: Время до выбора тура, процент выбравших тур
- **Передача партнеру**: Время передачи, процент успешных передач
- **Переключение AI ↔ Человек**: Количество переключений, причины, время ответа менеджера

### 2.7 Процесс экспериментирования с диалогами

**Название**: A/B тестирование промптов для улучшения конверсии  
**Участники**: Админ организации, AI-агенты, Клиенты  
**Триггер**: Админ создает варианты промптов для этапа диалога

**Шаги процесса**:

1. **Создание вариантов промптов**
   - Админ создает несколько вариантов промптов для одного этапа (например, квалификация)
   - Варианты отличаются тоном, структурой вопросов, подходом к продаже
   - Админ активирует эксперимент

2. **Назначение вариантов клиентам**
   - При первом контакте с клиентом система назначает ему вариант промпта:
     - Случайное назначение (равномерное распределение)
     - По правилам (на основе характеристик клиента)
     - Приоритетный вариант (по умолчанию)
   - Вариант сохраняется в профиле клиента
   - Клиент всегда получает один и тот же вариант для конкретного этапа

3. **Использование варианта в диалоге**
   - AI-агент использует назначенный вариант промпта при общении с клиентом
   - Все сообщения генерируются на основе этого варианта
   - Вариант используется на протяжении всего этапа диалога

4. **Сбор метрик**
   - Система автоматически собирает метрики для каждого варианта:
     - Конверсия в следующий этап воронки
     - Время до конверсии
     - Количество сообщений до конверсии
     - Процент клиентов дошедших до продажи
   - Метрики обновляются в реальном времени

5. **Анализ результатов**
   - Админ просматривает результаты экспериментов в интерфейсе
   - Система показывает сравнение метрик между вариантами
   - Админ может выбрать лучший вариант на основе результатов
   - Система может автоматически переключиться на лучший вариант (post-MVP)

**Результаты**:
- Определен лучший вариант промпта для этапа диалога
- Конверсия улучшена за счет использования оптимального подхода
- Система постоянно оптимизирует качество общения

**Исключения**:
- Если эксперимент не показывает значимых различий, админ может продлить эксперимент
- Если вариант показывает плохие результаты, админ может деактивировать его досрочно
- Можно запускать несколько экспериментов одновременно для разных этапов

**Метрики процесса**:
- Количество клиентов в каждом варианте
- Конверсия по вариантам
- Статистическая значимость различий (post-MVP)

### 2.8 Процесс анализа и улучшения диалогов

**Название**: Анализ диалогов и генерация рекомендаций по улучшению  
**Участники**: Система (модуль анализа), Админ организации  
**Триггер**: Автоматически (ежедневно) или по запросу админа

**Шаги процесса**:

1. **Сбор данных для анализа**
   - Система собирает все диалоги за период (например, последние 30 дней)
   - Система фильтрует диалоги по критериям:
     - Успешные диалоги (лид → продажа)
     - Неуспешные диалоги (лид → отказ)
     - Диалоги с эскалацией
   - Система группирует диалоги по:
     - Вариантам промптов
     - Языкам
     - Этапам воронки
     - Культурным контекстам

2. **Анализ успешных паттернов**
   - Система анализирует успешные диалоги:
     - Какие фразы и формулировки использовались
     - Какая структура вопросов была эффективной
     - Какие подходы привели к конверсии
     - Какие моменты были критичными для успеха
   - Система выявляет общие паттерны в успешных диалогах
   - Результаты сохраняются в системе

3. **Выявление проблемных мест**
   - Система анализирует неуспешные диалоги:
     - Где теряются клиенты
     - Что не работает в текущих промптах
     - Какие вопросы вызывают отказы
     - Какие моменты приводят к эскалации
   - Система сравнивает успешные и неуспешные диалоги
   - Результаты сохраняются в системе

4. **Генерация рекомендаций**
   - Система генерирует рекомендации на основе анализа:
     - Предложения по улучшению существующих промптов
     - Идеи для новых вариантов промптов
     - Выявленные проблемные места с предложениями по исправлению
     - Примеры успешных формулировок из диалогов
   - Рекомендации включают:
     - Обоснование (на основе каких данных)
     - Ожидаемый эффект (как это может улучшить конверсию)
     - Примеры из реальных диалогов
   - Рекомендации сохраняются в системе

5. **Автоматическая генерация вариантов (опционально)**
   - Система может автоматически генерировать варианты промптов:
     - На основе успешных паттернов
     - С учетом контекста (язык, этап воронки)
     - С описанием и обоснованием
   - Сгенерированные варианты предлагаются админу для рассмотрения
   - **MVP ограничение**: Базовая генерация, расширенная AI-генерация - post-MVP

6. **Просмотр и применение рекомендаций**
   - Админ просматривает рекомендации в интерфейсе
   - Админ может:
     - Принять рекомендацию и создать новый вариант промпта
     - Отклонить рекомендацию
     - Редактировать рекомендацию перед применением
     - Просмотреть примеры диалогов на которых основана рекомендация
   - При применении рекомендации создается новый вариант промпта
   - Новый вариант может быть сразу активирован или добавлен в эксперимент

**Результаты**:
- Выявлены успешные паттерны в диалогах
- Выявлены проблемные места в текущих промптах
- Сгенерированы рекомендации по улучшению
- Созданы новые варианты промптов на основе рекомендаций
- Качество диалогов и конверсия улучшены

**Исключения**:
- Если данных недостаточно для анализа, система может пропустить анализ или использовать данные за больший период
- Если рекомендации не применимы, админ может их отклонить
- Анализ может быть запущен вручную админом в любое время

**Метрики процесса**:
- Количество проанализированных диалогов
- Количество выявленных паттернов
- Количество сгенерированных рекомендаций
- Процент примененных рекомендаций
- Улучшение конверсии после применения рекомендаций

## 5. Улучшения процессов (Post-MVP)

### Автоматизация

- Автоматическая передача партнеру при выборе тура
- Автоматическое определение оптимального партнера
- Автоматическое напоминание клиентам о предстоящих турах

### Расширенные агенты

- Агент прогрева - поддержание интереса клиента между этапами
- Агент продажи - закрытие сделки
- Агент сервисного сопровождения - поддержка во время тура
- Агент обратной связи - сбор отзывов после тура
- Агент повторных продаж - предложение новых туров

### Аналитика

- Детальная аналитика по каждому процессу
- Прогнозирование конверсии
- Оптимизация процессов на основе данных

---

**Следующие шаги**:
1. Обновление MVP scope на основе этих процессов
2. Детализация процессов для Architecture Agent
3. Определение API контрактов для каждого процесса

