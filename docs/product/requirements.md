# Требования к продукту: Soul KG CRM

> **Версия**: 1.3  
> **Дата создания**: 2025-12-20  
> **Последнее обновление**: 2025-12-20  
> **Статус**: MVP Requirements

## 1. Обзор

### 1.1 Назначение

Soul KG CRM - это коммерческая мультитенантная SaaS CRM система с AI-агентами для автоматизации продаж туров и услуг в туристической сфере. Система позволяет организациям (туроператорам, отелям, гидам) автоматизировать общение с клиентами через WhatsApp, управлять воронкой продаж, квалифицировать лидов и передавать клиентов партнерам.

**Ключевая ценность**: Автоматизация рутинных задач общения с клиентами через AI-агентов, позволяя менеджерам фокусироваться на сложных случаях и стратегических задачах.

### 1.2 Целевая аудитория

**Первичные пользователи системы**:

1. **Менеджеры продаж** - сотрудники организаций, которые работают с клиентами
2. **Админы организаций** - управляют настройками организации, пользователями, продуктами, партнерами
3. **Супер-админы платформы** - управляют платформой, создают новые организации (post-MVP)

**Конечные пользователи (через WhatsApp)**:

4. **Клиенты** - потенциальные и текущие клиенты организаций, которые общаются через WhatsApp

**Целевые организации (клиенты платформы)**:

- Туроператоры (как Soul KG)
- Отели
- Гиды и экскурсионные компании
- Другие организации в туристической сфере

### 1.3 Область применения

Система используется для:

- **Автоматизации общения с клиентами** через WhatsApp с помощью AI-агентов
- **Управления воронкой продаж** - отслеживание статусов клиентов от лида до продажи
- **Квалификации лидов** - автоматическое определение готовности клиента к покупке
- **Подбора туров** - предложение подходящих продуктов на основе потребностей клиента
- **Передачи клиентов партнерам** - автоматическая или ручная передача клиентов партнерам для исполнения
- **Учета клиентов и истории общения** - централизованное хранение всех данных о клиентах

## 2. Функциональные требования

### 2.1 Мультитенантность (архитектурно с самого начала)

**⚠️ КРИТИЧНО**: Мультитенантность - основа продукта. Должна быть заложена архитектурно с самого начала, даже если в MVP будет только одна организация (Soul KG).

**FR-MT-001: Создание и управление организациями**
- Система должна позволять создавать организации (tenants)
- Каждая организация имеет уникальный идентификатор (tenant_id)
- Организация имеет базовые данные: название, контакты, настройки
- **MVP ограничение**: В MVP создается только одна организация (Soul KG) вручную, но архитектура готова к множеству организаций

**FR-MT-002: Изоляция данных**
- Все данные должны быть изолированы по организациям через `tenant_id` во всех таблицах
- Организация не должна видеть данные других организаций
- Использование Row Level Security (RLS) в PostgreSQL для гарантии изоляции
- Все запросы к БД должны автоматически фильтроваться по `tenant_id`

**FR-MT-003: Управление доступом организаций**
- Каждая организация имеет свой набор пользователей
- Пользователи привязаны к организации и не могут получить доступ к данным других организаций
- **Post-MVP**: Супер-админ может создавать новые организации и управлять доступом

**FR-MT-004: Настройки организаций**
- Каждая организация может настраивать:
  - Промпты для AI-агентов (тон общения, стиль, правила)
  - Брендинг (название организации, логотип)
  - Каналы связи (WhatsApp, Telegram - архитектурно заложено)
  - Продукты и услуги
  - Партнеров
- Настройки изолированы между организациями

### 2.2 Управление клиентами

**FR-CL-001: Создание клиента**
- Система должна позволять создавать нового клиента с полями:
  - Имя
  - Телефон (обязательно, используется для WhatsApp)
  - Email (опционально)
  - Статус (автоматически `new_lead` при создании)
- Клиент автоматически привязывается к организации (tenant_id)
- Клиент может быть создан вручную или автоматически при первом сообщении в WhatsApp

**FR-CL-002: Просмотр и редактирование клиента**
- Система должна отображать профиль клиента со всей информацией
- Можно редактировать данные клиента вручную
- Можно добавлять дополнительные поля (заметки, теги, метаданные)

**FR-CL-003: История общения**
- Система должна отображать всю историю общения с клиентом
- История включает:
  - Дата и время сообщения
  - Отправитель (AI-агент / человек / клиент)
  - Текст сообщения
  - Канал связи (WhatsApp, Telegram и т.д.)
- История отсортирована по дате (новые сверху)
- История сохраняется автоматически при каждом сообщении

**FR-CL-004: Статусы клиентов (воронка продаж)**
- Система должна поддерживать следующие статусы:
  - `new_lead` - Новый лид (только что написал)
  - `qualified` - Квалифицирован (определены потребности, бюджет, даты)
  - `warmed` - Прогрет (получил информацию, заинтересован)
  - `proposal_sent` - Отправлено предложение (конкретные туры)
  - `negotiation` - Переговоры (обсуждение деталей)
  - `sold` - Продано (клиент купил тур)
  - `service` - Сервисное сопровождение (поддержка во время тура)
  - `feedback` - Обратная связь (сбор отзывов после тура)
  - `repeat_sale` - Повторная продажа (клиент готов к новому туру)
- Статус можно изменять вручную или автоматически (AI-агентами)
- История изменений статусов сохраняется

**FR-CL-005: Привязка к продуктам**
- Клиент может быть привязан к продуктам (турам)
- Можно отслеживать какие туры интересны клиенту
- Можно отслеживать какие туры клиент выбрал/купил

**FR-CL-006: Импорт данных из WhatsApp**
- Система должна позволять импортировать существующие данные из WhatsApp переписки
- Извлечение данных:
  - Имя клиента (из контакта или сообщений)
  - Телефон
  - История сообщений
  - Контекст общения (для определения статуса)
- Парсинг неструктурированных данных из чатов
- Инструмент для ручной проверки и корректировки импортированных данных
- **MVP ограничение**: Базовый импорт, расширенный парсинг - post-MVP

### 2.3 Интеграция с WhatsApp

**FR-WA-001: Подключение WhatsApp Web**
- Система должна подключаться к WhatsApp через whatsapp-web.js
- Авторизация через QR-код (отображение в UI)
- Сохранение и восстановление сессии
- Автоматическое переподключение при разрыве соединения
- **Ограничение**: Только WhatsApp Web, официального API нет

**FR-WA-002: Получение входящих сообщений**
- Система должна получать все входящие сообщения от клиентов
- Сообщения обрабатываются через event listener
- Сообщения сохраняются в БД с привязкой к клиенту
- Если клиент не существует, создается новый клиент со статусом `new_lead`

**FR-WA-003: Отправка сообщений**
- Система должна отправлять сообщения через очередь (BullMQ)
- Сообщения ставятся в очередь для соблюдения rate limits (~20 сообщений/мин)
- Сообщения могут отправляться от имени AI-агента или человека
- История отправленных сообщений сохраняется в БД

**FR-WA-004: Обнаружение вмешательства менеджера через WhatsApp**
- Система должна обнаруживать когда менеджер пишет клиенту напрямую через WhatsApp (минуя CRM)
- При обнаружении сообщения от менеджера (`fromMe === true` в WhatsApp Web):
  - Система синхронизирует сообщение с CRM (сохраняет в историю общения)
  - Система определяет что диалог переключен на менеджера
  - AI-агент прекращает автоматические ответы для этого клиента
  - Статус диалога обновляется на "managed_by_human"
- Менеджер может вернуть диалог AI через CRM интерфейс
- Система должна обрабатывать случаи когда менеджер пишет через WhatsApp, а затем через CRM (или наоборот)
- **MVP ограничение**: Базовая синхронизация, расширенная обработка конфликтов - post-MVP

**FR-WA-004: Обработка ошибок**
- Система должна обрабатывать ошибки подключения
- Система должна обрабатывать ошибки отправки сообщений
- При ошибке отправки сообщение возвращается в очередь для повторной попытки
- Уведомление менеджера при критичных ошибках

**FR-WA-005: Управление сессией**
- Система должна управлять сессией WhatsApp для каждой организации отдельно
- Сессия сохраняется и восстанавливается при перезапуске
- При потере сессии система должна уведомить менеджера для повторной авторизации

### 2.4 AI-агенты

**FR-AI-001: Агент общения (базовый)**
- Система должна иметь базовый AI-агент для ответов на сообщения клиентов
- Агент должен понимать контекст разговора
- Агент должен генерировать ответы в стиле организации (на основе промптов)
- Агент должен определять намерения клиента
- **Вопрос для проработки**: Один агент или несколько специализированных агентов?

**FR-AI-002: Агент квалификации**
- Система должна иметь агент для квалификации лидов
- Агент должен задавать вопросы из анкеты квалификации:
  - Даты поездки (точные/окно)
  - Количество человек (pax)
  - Уровень активности
  - Бюджетный коридор
  - Пожелания по питанию (в т.ч. халяль)
  - Чувствительные моменты (холод/дороги/высота/страхи)
- Агент должен сохранять ответы в профиле клиента
- При успешной квалификации статус автоматически обновляется на `qualified`

**FR-AI-003: Агент подбора тура**
- Система должна иметь агент для подбора туров
- Агент должен анализировать данные квалификации клиента
- Агент должен выбирать подходящие туры из базы продуктов
- Агент должен предлагать 1-2 варианта туров с объяснением различий
- Агент должен уточнять детали (опции, питание, особые пожелания)
- Агент должен формировать "заказ-карту" с полной информацией

**FR-AI-004: Настройка AI-агентов**
- Каждая организация может настраивать промпты для AI-агентов
- Промпты определяют:
  - Тон общения (тёплый, спокойный, уверенный)
  - Стиль общения (в соответствии с брендом организации)
  - Правила и ограничения
  - Что можно/нельзя обещать
- Настройки изолированы между организациями

**FR-AI-007: Многоязычность и культурный контекст**
- AI-агенты должны понимать и отвечать на разных языках:
  - Английский (основной для целевой аудитории - экспаты из ОАЭ)
  - Европейские языки (немецкий, французский, испанский и т.д.)
  - Арабский
  - Русский
- AI-агенты должны определять язык клиента автоматически
- AI-агенты должны отвечать на том же языке, на котором пишет клиент
- Система должна учитывать культурный контекст:
  - Различия в стиле общения (формальность, прямолинейность)
  - Культурные особенности (халяль для мусульман, особенности общения с арабами)
  - Часовые пояса и временные предпочтения
- **Ограничение MVP**: Базовая поддержка английского и русского, определение языка, остальные языки - post-MVP

**FR-AI-005: Переключение AI ↔ Человек**
- Менеджер может "взять" диалог у AI в любой момент:
  - **Через CRM интерфейс**: Менеджер нажимает кнопку "Взять диалог"
  - **Через WhatsApp напрямую**: Менеджер пишет клиенту напрямую через WhatsApp, система автоматически обнаруживает это
- После вмешательства человека AI может продолжить диалог (если менеджер вернул диалог)
- Система должна фиксировать кто отвечал (AI или человек) и откуда (CRM или WhatsApp)
- История показывает кто отвечал на каждое сообщение и через какой канал
- **Синхронизация**: Если менеджер пишет через WhatsApp напрямую, сообщение должно синхронизироваться с CRM
- **Многоязычность**: При переключении на менеджера система должна показывать:
  - **Оригинальное сообщение клиента** (на языке клиента)
  - **Перевод сообщения** на язык менеджера (если языки разные)
  - Оба варианта отображаются одновременно для удобства менеджера
  - Менеджер пишет ответ на своем языке, система автоматически переводит на язык клиента
  - Культурные заметки (если применимо) - подсказки о культурных особенностях клиента

**FR-AI-006: Уведомления менеджера**
- Система должна уведомлять менеджера в критичных моментах:
  - Квалифицированный лид
  - Готовый заказ
  - Запрос на передачу менеджеру от клиента
  - Эскалация (клиент недоволен, сложный вопрос)
  - По запросу менеджера
- Уведомления показывают:
  - Контекст диалога
  - Статус клиента
  - Что нужно сделать
- **Вопрос для проработки**: Как уведомлять? (внутри CRM, email, push)

### 2.5 Управление партнерами

**FR-PA-001: CRUD операции с партнерами**
- Система должна позволять создавать, просматривать, редактировать и удалять партнеров
- Партнер имеет поля:
  - Название
  - Контакты (телефон, email, WhatsApp, Telegram)
  - Условия сотрудничества
  - Рейтинг (опционально)
  - Доступность
- Партнеры привязаны к организации (tenant_id)

**FR-PA-002: Продукты партнеров**
- Партнер может иметь связанные продукты (которые организация продает)
- Продукт может быть связан с партнером или не связан
- Один продукт может быть связан с несколькими партнерами
- Описание продуктов партнеров и цены хранятся в системе

**FR-PA-003: Передача клиента партнеру**
- Система должна позволять передавать клиента партнеру
- Передача может быть автоматической (AI) или ручной (менеджер)
- При передаче отправляется информация о клиенте через:
  - WhatsApp (основной способ)
  - Telegram (опционально)
  - Email (опционально)
- Информация включает:
  - Данные клиента (имя, телефон, email)
  - Выбранный тур
  - Предпочтения клиента
  - Даты поездки

### 2.6 Управление продуктами

**FR-PR-001: CRUD операции с продуктами**
- Система должна позволять создавать, просматривать, редактировать и удалять продукты (шаблоны туров)
- Продукт имеет поля:
  - Название
  - Описание
  - Длительность (3-4 дня, 5-7 дней, 4-6 дней для VIP)
  - Тип (Weekend Getaway, Exploration & Connection, Private Escape/VIP)
  - Цена (базовая, по группам, индивидуальная)
  - Включено/не включено
  - Опции (баня, снегоходы, орлы и т.д.)
- Продукты привязаны к организации (tenant_id)
- **Важно**: Продукт - это шаблон тура, конкретные туры с датами создаются отдельно (см. FR-PR-004)

**FR-PR-002: Связь продуктов с партнерами**
- Продукт может быть связан с партнером или не связан
- Один продукт может быть связан с несколькими партнерами
- При выборе продукта клиентом система определяет связанного партнера

**FR-PR-004: Управление турами (конкретные экземпляры продуктов)**
- Система должна позволять создавать конкретные туры с датами на основе продуктов
- Тур имеет поля:
  - Продукт (ссылка на шаблон)
  - Дата начала тура
  - Дата окончания тура
  - Максимальное количество участников
  - Текущее количество участников
  - Цена (может отличаться от базовой цены продукта)
  - Статус (доступен, заполнен, отменен, завершен)
- Один продукт может иметь множество туров с разными датами
- Клиент выбирает конкретный тур с конкретной датой, а не просто продукт
- Система должна показывать доступные туры на основе дат, выбранных клиентом

**FR-PR-003: Цены на продукты**
- Система должна поддерживать разные типы цен:
  - Базовая цена (в продукте)
  - Цена конкретного тура (может отличаться от базовой)
  - Цена по размеру группы (1-4 pax)
  - Индивидуальная цена (для конкретного клиента)
- Цены могут изменяться в зависимости от дат, сезона

### 2.7 Уведомления и эскалация

**FR-NT-001: Уведомления менеджера**
- Система должна уведомлять менеджера в критичных моментах (см. FR-AI-006)
- Уведомления должны быть видны в интерфейсе CRM
- **Вопрос для проработки**: Дополнительные каналы уведомлений (email, push)?

**FR-NT-002: Эскалация**
- Система должна определять ситуации требующие эскалации:
  - Клиент недоволен
  - Сложный вопрос, на который AI не может ответить
  - Запрос на передачу менеджеру от клиента
- При эскалации менеджер получает уведомление с контекстом

### 2.8 Импорт данных

**FR-IM-001: Импорт из WhatsApp**
- Система должна позволять импортировать существующие данные из WhatsApp переписки
- Извлечение данных:
  - Имя клиента
  - Телефон
  - История сообщений
  - Контекст общения (для определения статуса)
- Парсинг неструктурированных данных из чатов
- Инструмент для ручной проверки и корректировки импортированных данных
- **MVP ограничение**: Базовый импорт, расширенный парсинг - post-MVP

## 3. Нефункциональные требования

### 3.1 Производительность

**NFR-PF-001: Нагрузка**
- Система должна одновременно поддерживать 20 и более открытых активных переписок на организацию (одновременная работа менеджеров и AI с 20+ клиентами онлайн)
- Общее количество клиентов в базе для одной организации должно поддерживаться на уровне 1000+ без деградации производительности
- Система должна поддерживать множественные организации (архитектурно заложено)

**NFR-PF-002: Время отклика**
- Время отклика на действия пользователя не должно превышать 2 секунд (p95)
- Время обработки сообщения WhatsApp не должно превышать 5 секунд (p95)
- Время генерации ответа AI-агентом не должно превышать 10 секунд (p95)

**NFR-PF-003: Обработка сообщений**
- Система должна обрабатывать сообщения через очередь (BullMQ)
- Соблюдение rate limits WhatsApp (~20 сообщений/мин)
- Сообщения не должны теряться при сбоях

### 3.2 Безопасность

**NFR-SE-001: Изоляция данных**
- Полная изоляция данных между организациями через RLS в PostgreSQL
- Невозможность доступа организации к данным других организаций
- Все запросы автоматически фильтруются по tenant_id

**NFR-SE-002: Аутентификация и авторизация**
- Аутентификация пользователей через JWT токены
- Авторизация на уровне организации
- Пользователь не может получить доступ к данным других организаций

**NFR-SE-003: Защита от утечки данных**
- Валидация всех входных данных
- Защита от SQL инъекций (через ORM)
- Защита от XSS атак
- Шифрование чувствительных данных

**NFR-SE-004: Безопасность WhatsApp сессий**
- Сессии WhatsApp должны храниться безопасно
- Доступ к сессиям только для авторизованных пользователей организации

### 3.3 Масштабируемость

**NFR-SC-001: Множественные организации**
- Архитектура должна поддерживать множественные организации с самого начала
- Добавление новой организации не должно требовать изменений в коде
- Система должна масштабироваться горизонтально

**NFR-SC-002: Дополнительные каналы**
- Архитектура должна быть готова к добавлению других каналов связи (Telegram, email, телефон)
- Добавление нового канала не должно требовать изменений в основной логике

**NFR-SC-003: Расширение функциональности**
- Система должна быть модульной для легкого добавления новых функций
- AI-агенты должны быть легко расширяемы

### 3.4 Надежность

**NFR-RE-001: Стабильность**
- Система должна работать стабильно (uptime > 95%)
- Автоматическое восстановление при сбоях
- Резервное копирование данных

**NFR-RE-002: Обработка ошибок**
- Все ошибки должны логироваться
- Критичные ошибки должны уведомлять менеджера
- Graceful degradation при недоступности внешних сервисов

**NFR-RE-003: WhatsApp переподключение**
- Автоматическое переподключение при разрыве соединения WhatsApp
- Сохранение и восстановление сессии
- Уведомление при необходимости повторной авторизации

**NFR-RE-004: Резервное копирование данных**
- Автоматическое ежедневное резервное копирование базы данных
- Хранение backup в облачном хранилище (AWS S3, Google Cloud Storage)
- Хранение последних 30 дней backup
- RTO (Recovery Time Objective): 4 часа
- RPO (Recovery Point Objective): 24 часа
- Автоматическое тестирование восстановления из backup (раз в неделю)

**NFR-RE-005: Мониторинг и алертинг**
- Мониторинг производительности системы (response time, throughput)
- Мониторинг состояния очередей (queue length, processing time)
- Мониторинг состояния WhatsApp подключений
- Мониторинг метрик AI-агентов (execution time, token usage)
- Алерты при критичных ошибках через Telegram
- Алерты при разрыве WhatsApp соединения (> 5 минут)
- Алерты при высокой нагрузке на очередь (> 100 сообщений в очереди)
- Алерты при медленных запросах (response time > 2 секунд)
- Алерты при высокой частоте ошибок (error rate > 5%)
- Использование Sentry для отслеживания ошибок
- Структурированное логирование (JSON формат)

### 3.5 Удобство использования

**NFR-UX-001: Интерфейс**
- Интерфейс должен быть интуитивно понятен
- Основные задачи должны выполняться без обучения
- Ошибки должны обрабатываться gracefully с понятными сообщениями

**NFR-UX-002: Мобильная адаптация**
- Интерфейс должен быть адаптирован для мобильных устройств
- **MVP ограничение**: Базовая адаптация, полноценное мобильное приложение - post-MVP

**NFR-UX-003: Многоязычность интерфейса**
- Интерфейс CRM должен поддерживать несколько языков для менеджеров:
  - Русский (основной для операторов)
  - Английский (для международных команд)
- Переключение языка интерфейса должно быть простым
- **MVP ограничение**: Русский и английский интерфейс, остальные языки - post-MVP

## 4. Ограничения

### 4.1 Технические ограничения

**LIM-TE-001: WhatsApp Web**
- Только WhatsApp Web (whatsapp-web.js), официального API нет
- Требуется QR-код для первого подключения
- Необходимо управление сессией и переподключение
- Rate limits: ~20 сообщений/мин
- Риск блокировки при злоупотреблении

**LIM-TE-002: Отсутствие других каналов в MVP**
- Только WhatsApp в MVP
- Telegram, email, телефон - архитектурно заложено, но не в MVP

**LIM-TE-003: Простые AI-агенты в MVP**
- Базовые агенты (общение, квалификация, подбор тура)
- Расширенные агенты (прогрев, продажа, сервис, обратная связь) - post-MVP

**LIM-TE-004: Одна организация в MVP**
- Только одна организация (Soul KG) для тестирования MVP
- Множественные организации - архитектурно заложено, но не в MVP

### 4.2 Бизнес-ограничения

**LIM-BU-001: Ручной учет платежей**
- Учет платежей вручную в MVP
- Модуль платежей архитектурно заложен, но не реализован

**LIM-BU-002: Ручной расчет с партнерами**
- Расчет с партнерами вручную в MVP
- Интеграция для автоматического расчета - архитектурно заложено, но не реализовано

**LIM-BU-003: Простые профили клиентов**
- Базовые поля клиента в MVP
- Расширенные профили - post-MVP

**LIM-BU-004: Фиксированные статусы**
- Фиксированный набор статусов в MVP
- Кастомизация статусов - post-MVP

## 5. Интеграции

### 5.1 Внешние интеграции

**INT-001: WhatsApp Web**
- Интеграция через whatsapp-web.js
- Основной канал связи для MVP
- См. детали в `docs/integrations/whatsapp-web-integration.md`

### 5.2 Будущие интеграции (архитектурно заложено)

**INT-002: Telegram Bot API**
- Интеграция для будущих каналов связи
- Архитектурно заложено, но не в MVP

**INT-003: Email**
- Интеграция для отправки email уведомлений
- Архитектурно заложено, но не в MVP

**INT-004: WhatsApp Business API**
- Миграция на официальный API когда будет доступен
- Архитектурно заложено, но не в MVP

**INT-005: Платежные системы**
- Интеграция для автоматического учета платежей
- Архитектурно заложено, но не в MVP

## 6. Требования к данным

### 6.1 Структура данных

**DATA-001: Мультитенантность**
- Все таблицы должны иметь поле `organization_id` (tenant_id)
- Все запросы должны фильтроваться по organization_id
- Использование RLS в PostgreSQL для гарантии изоляции

**DATA-002: Клиенты**
- Таблица `clients` с полями: id, organization_id, name, phone, email, status, preferred_language, cultural_context, created_at, updated_at
  - `preferred_language` - предпочтительный язык клиента (en, ru, ar, de, fr, es и т.д.)
  - `cultural_context` - культурный контекст (JSON: халяль, формальность, часовой пояс и т.д.)
- История общения в таблице `messages` с привязкой к клиенту
- История изменений статусов в таблице `status_history`

**DATA-003: Продукты**
- Таблица `products` с полями: id, organization_id, name, description, duration, type, price, created_at, updated_at
- Связь продуктов с партнерами через таблицу `product_partners`

**DATA-004: Партнеры**
- Таблица `partners` с полями: id, organization_id, name, contacts, rating, availability, created_at, updated_at

**DATA-005: Сообщения**
- Таблица `messages` с полями: id, organization_id, client_id, sender_type (ai/human/client), sender_id, text, language, channel, created_at
  - `language` - язык сообщения (определяется автоматически)

### 6.2 Хранение данных

**DATA-006: База данных**
- PostgreSQL с pgvector для векторного поиска (для будущего RAG)
- Резервное копирование данных ежедневно
- Миграции через Prisma

**DATA-007: Кэширование**
- Redis для кэширования сессий и временных данных
- Кэширование промптов AI-агентов для производительности

## 7. Многоязычность и культурный контекст

### 7.1 Поддерживаемые языки

**Языки клиентов (через WhatsApp) - MVP**:
- Английский (основной для целевой аудитории - экспаты из ОАЭ)
- Русский
- Арабский
- Французский
- Немецкий
- Испанский
- Польский

**Языки интерфейса CRM (для менеджеров)**:
- Русский (основной для операторов)
- Английский (для международных команд)

**Примечание**: AI-агенты автоматически определяют язык клиента и общаются на его языке. Переводчик для менеджеров работает между всеми поддерживаемыми языками.

### 7.2 Требования к AI-агентам

**FR-ML-001: Определение языка**
- AI-агенты должны автоматически определять язык входящего сообщения
- Определенный язык сохраняется в профиле клиента
- Система должна помнить предпочтительный язык клиента для будущих диалогов

**FR-AI-008: Адаптивный флоу общения**
- Флоу общения должен быть адаптивным на высоком уровне абстракции:
  - Квалификация → Подбор продукта → Закрытие сделки
- На детальном уровне система должна постоянно улучшать качество диалога:
  - Экспериментирование с промптами и стратегиями общения
  - A/B тестирование различных подходов к диалогу
  - Измерение конверсии для каждого варианта
  - Автоматический выбор лучших стратегий на основе метрик
- Система должна позволять:
  - Создавать варианты промптов для одного и того же этапа диалога
  - Назначать варианты клиентам случайным образом или по правилам
  - Собирать метрики конверсии для каждого варианта
  - Анализировать результаты и рекомендовать лучшие варианты
- **MVP ограничение**: Базовая поддержка вариантов промптов, расширенная аналитика - post-MVP

**FR-ML-002: Ответы на языке клиента**
- AI-агенты должны отвечать на том же языке, на котором пишет клиент
- AI автоматически определяет язык клиента и продолжает общение на этом языке
- Если язык не поддерживается, агент должен ответить на английском с извинением
- **MVP языки**: Английский, русский, арабский, французский, немецкий, испанский, польский

**FR-ML-003: Культурный контекст**
- AI-агенты должны учитывать культурные особенности:
  - Стиль общения (формальность для европейцев, более теплый для арабов)
  - Особенности питания (халяль для мусульман)
  - Часовые пояса и временные предпочтения
  - Культурные табу и особенности
- Культурные настройки могут быть настроены для каждой организации

**FR-ML-004: Переводчик для менеджеров**
- При переключении диалога на менеджера система должна показывать:
  - **Оригинальное сообщение клиента** (на языке клиента)
  - **Перевод сообщения клиента** на язык менеджера (если языки разные)
  - Менеджер видит оба варианта одновременно
- Менеджер пишет ответ на своем удобном языке (обычно русском)
- Система автоматически переводит ответ менеджера на язык клиента перед отправкой
- Переводчик должен быть контекстуальным (учитывать туристическую терминологию)
- Переводчик должен быть качественным (использовать профессиональный сервис перевода)
- **MVP языки для перевода**: Английский ↔ Русский ↔ Арабский ↔ Французский ↔ Немецкий ↔ Испанский ↔ Польский

### 7.3 Ограничения MVP

**LIM-ML-001: Языки в MVP**
- Поддержка следующих языков для клиентов: английский, русский, арабский, французский, немецкий, испанский, польский
- Автоматическое определение языка из поддерживаемых языков
- Переводчик для менеджеров между всеми поддерживаемыми языками
- Остальные языки - архитектурно заложено, но не реализовано в MVP

**LIM-ML-002: Культурный контекст в MVP**
- Базовая поддержка культурных особенностей (халяль, формальность)
- Расширенная настройка культурного контекста - post-MVP

**LIM-ML-003: Переводчик в MVP**
- Использование профессионального сервиса перевода (Google Translate API, DeepL API или аналогичный)
- Контекстуальный перевод с учетом туристической терминологии
- Переводчик работает в обе стороны: клиент → менеджер и менеджер → клиент

## 8. Экспериментирование и оптимизация конверсии

### 8.1 A/B тестирование диалогов

**FR-EXP-001: Варианты промптов**
- Система должна позволять создавать несколько вариантов промптов для одного этапа диалога
- Варианты могут отличаться:
  - Тоном общения (более формальный vs более дружелюбный)
  - Структурой вопросов (прямые vs косвенные)
  - Длиной ответов (краткие vs подробные)
  - Подходом к продаже (мягкий vs прямой)
- Каждый вариант имеет название и описание

**FR-EXP-002: Назначение вариантов клиентам**
- Система должна назначать варианты клиентам:
  - **Случайное назначение**: Равномерное распределение между вариантами
  - **Правила назначения**: На основе характеристик клиента (язык, культурный контекст, статус)
  - **Приоритетные варианты**: Можно указать какой вариант использовать по умолчанию
- Один клиент всегда получает один вариант для конкретного этапа диалога
- Вариант сохраняется в профиле клиента и используется во всех диалогах с этим клиентом

**FR-EXP-003: Сбор метрик конверсии**
- Система должна собирать метрики для каждого варианта:
  - Конверсия в следующий этап воронки (qualified → proposal_sent → sold)
  - Время до конверсии
  - Количество сообщений до конверсии
  - Процент клиентов дошедших до продажи
  - Процент отказов на этапе
- Метрики собираются автоматически на основе статусов клиентов и истории общения
- Метрики агрегируются по вариантам промптов

**FR-EXP-004: Анализ результатов**
- Система должна анализировать результаты экспериментов:
  - Сравнение метрик между вариантами
  - Статистическая значимость различий
  - Рекомендации по выбору лучшего варианта
- Админ может просматривать результаты экспериментов в интерфейсе
- Система может автоматически переключаться на лучший вариант (опционально)

**FR-EXP-005: Управление экспериментами**
- Админ может:
  - Создавать новые варианты промптов (вручную)
  - Редактировать существующие варианты
  - Активировать/деактивировать варианты
  - Настраивать правила назначения вариантов
  - Просматривать результаты экспериментов
- Эксперименты могут быть ограничены по времени или количеству клиентов
- Можно запускать несколько экспериментов одновременно для разных этапов диалога

**FR-EXP-006: Анализ диалогов и автоматическая генерация вариантов**
- Система должна анализировать историю успешных диалогов:
  - Диалоги с высокой конверсией (лид → продажа)
  - Паттерны общения в успешных диалогах
  - Что работает лучше (тон, структура, подход)
- Система должна предлагать новые варианты промптов на основе анализа:
  - Автоматическая генерация вариантов на основе успешных паттернов
  - Рекомендации по улучшению существующих промптов
  - Выявление проблемных мест в текущих промптах
- Админ может:
  - Просматривать предложенные варианты
  - Принимать или отклонять предложения
  - Редактировать предложенные варианты перед активацией
- **MVP ограничение**: Базовая аналитика успешных диалогов, ручная генерация вариантов на основе рекомендаций

**FR-EXP-007: Модуль анализа и улучшения диалогов**
- Система должна анализировать все диалоги и выявлять:
  - **Успешные паттерны**: Что работает хорошо (фразы, подходы, структура вопросов)
  - **Проблемные места**: Где теряются клиенты, что не работает
  - **Оптимальные моменты**: Когда лучше задавать вопросы, когда предлагать продукт
  - **Языковые особенности**: Какие формулировки лучше работают на разных языках
- Система должна предоставлять рекомендации:
  - Как улучшить промпты на основе данных
  - Какие варианты стоит протестировать
  - Какие изменения могут повысить конверсию
- Анализ должен учитывать:
  - Контекст клиента (язык, культурный контекст, статус)
  - Этап воронки (квалификация, подбор, продажа)
  - Результат диалога (конверсия, отказ, эскалация)
- **MVP ограничение**: Базовая аналитика, расширенный AI-анализ - post-MVP

**Ограничения MVP**:
- Базовая поддержка вариантов промптов (2-3 варианта на этап)
- Ручное создание вариантов админом
- Базовая аналитика успешных диалогов (без автоматической генерации)
- Рекомендации на основе данных (без автоматической генерации вариантов)
- Простые метрики конверсии (без статистической значимости)
- Расширенная аналитика, автоматическая генерация вариантов и AI-рекомендации - post-MVP

## 9. Требования, требующие уточнения

### Вопросы по мультитенантности

1. **Управление организациями**:
   - Как создаются новые организации? Кто имеет права создавать?
   - Какой процесс онбординга новых организаций?
   - Какие данные нужны для создания организации? (название, контакты, настройки)

2. **Биллинг и подписки** (post-MVP, но архитектурно заложить):
   - Как будет работать коммерческая модель? (подписка, тарифы, лимиты)
   - Какие метрики важны для биллинга? (количество клиентов, сообщений, пользователей)
   - Как отслеживать использование ресурсов?

3. **Супер-админ платформы**:
   - Какие функции нужны для управления платформой?
   - Как мониторить использование системы?
   - Как управлять доступом организаций?

### Вопросы по функциональности

1. **Архитектура диалога с клиентом**: Один AI-агент или несколько специализированных агентов?
   - Если несколько: как они взаимодействуют, передают контекст, переключаются?
   - Если один: как он управляет разными этапами воронки?

2. **Модуль анализа и улучшения диалогов**:
   - Какой AI-сервис использовать для анализа диалогов? (OpenAI, Anthropic, локальный LLM?)
   - Как часто запускать анализ? (реал-тайм, ежедневно, по запросу?)
   - Какие метрики использовать для определения "успешности" диалога?
   - Как хранить результаты анализа? (отдельная таблица, кэш, векторная БД?)

2. **Механизм уведомлений менеджера**:
   - Когда уведомлять? (критичные моменты, эскалация, по запросу)
   - Как уведомлять? (внутри CRM, email, push)
   - Что показывать в уведомлении? (контекст диалога, статус клиента, что нужно сделать)

3. **Переключение AI ↔ Человек**:
   - Как менеджер "берет" диалог у AI?
   - Как AI продолжает после вмешательства человека?
   - Как фиксируется кто отвечал (AI или человек)?

4. **Структура продуктов**:
   - Как связаны "наши продукты" и "продукты партнеров"?
   - Может ли один продукт быть связан с несколькими партнерами?
   - Как хранить цены (базовые, по группам, индивидуальные)?

5. **Импорт данных из WhatsApp**:
   - Как извлечь историю переписки из WhatsApp?
   - Какие данные извлекать? (имя, телефон, контекст общения, статус клиента)
   - Как структурировать неструктурированные данные из чатов?
   - Нужен ли инструмент для ручной проверки/корректировки импортированных данных?

### Вопросы по многоязычности

1. **Определение языка**:
   - Как точно определять язык коротких сообщений?
   - Что делать если клиент пишет на смеси языков?
   - Как обрабатывать сообщения с эмодзи и сленгом?
   - Какой сервис определения языка использовать? (Google Cloud Translation API, AWS Comprehend, или библиотека?)

2. **Перевод для менеджеров**:
   - Какой сервис перевода использовать? (Google Translate API, DeepL API, Azure Translator?)
   - Как обеспечить качество перевода туристической терминологии? (глоссарий терминов?)
   - Как показывать перевод в интерфейсе? (рядом с оригиналом, в отдельной панели?)
   - Нужна ли возможность редактировать перевод перед отправкой?

3. **Культурный контекст**:
   - Какие культурные особенности критичны для MVP?
   - Как настраивать культурный контекст для разных организаций?
   - Нужны ли шаблоны ответов с учетом культурных особенностей?
   - Как учитывать часовые пояса при общении?

4. **Языки интерфейса**:
   - Какие языки интерфейса критичны для MVP? (русский + английский достаточно?)
   - Как организовать перевод интерфейса? (i18n библиотека: react-i18next, next-intl?)

---

**Следующие шаги**:
1. Создание user stories на основе этих требований
2. Описание бизнес-процессов
3. Обновление MVP scope при необходимости

